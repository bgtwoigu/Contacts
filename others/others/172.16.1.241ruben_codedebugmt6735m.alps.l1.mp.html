<html>
<head>
  <title>\\172.16.1.241\ruben_code\debug\mt6735m.alps.l1.mp6.v2.8\frameworks\base\services\java\com\android\server\SystemServer.java\SystemServer.java</title>
  <basefont face="Microsoft YaHei" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/301769 (zh-CN); Windows/6.3.9600 (Win64);"/>
  <style>
    body, td {
      font-family: Microsoft YaHei;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="767"/>
<h1>\\172.16.1.241\ruben_code\debug\mt6735m.alps.l1.mp6.v2.8\frameworks\base\services\java\com\android\server\SystemServer.java\SystemServer.java</h1>

<div>
<span><div>/*</div><div>* Copyright (C) 2014 MediaTek Inc.</div><div>* Modification based on code covered by the mentioned copyright</div><div>* and/or permission notice(s).</div><div>*/</div><div>/*</div><div> * Copyright (C) 2006 The Android Open Source Project</div><div> *</div><div> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div> * you may not use this file except in compliance with the License.</div><div> * You may obtain a copy of the License at</div><div> *</div><div> *      http://www.apache.org/licenses/LICENSE-2.0</div><div> *</div><div> * Unless required by applicable law or agreed to in writing, software</div><div> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div> * See the License for the specific language governing permissions and</div><div> * limitations under the License.</div><div> */</div><div>package com.android.server;</div><div><br/></div><div>import android.app.ActivityManagerNative;</div><div>import android.app.ActivityThread;</div><div>import android.app.IAlarmManager;</div><div>import android.app.INotificationManager;</div><div>import android.app.usage.UsageStatsManagerInternal;</div><div>import android.bluetooth.BluetoothAdapter;</div><div>import android.content.ComponentName;</div><div>import android.content.ContentResolver;</div><div>import android.content.Context;</div><div>import android.content.Intent;</div><div>import android.content.pm.IPackageManager;</div><div>import android.content.pm.PackageManager;</div><div>import android.content.res.Configuration;</div><div>import android.media.AudioService;</div><div>import android.media.tv.TvInputManager;</div><div>import android.os.Build;</div><div>import android.os.Environment;</div><div>import android.os.FactoryTest;</div><div>import android.os.Handler;</div><div>import android.os.IBinder;</div><div>import android.os.IPowerManager;</div><div>import android.os.Looper;</div><div>import android.os.RemoteException;</div><div>import android.os.ServiceManager;</div><div>import android.os.StrictMode;</div><div>import android.os.SystemClock;</div><div>import android.os.SystemProperties;</div><div>import android.os.UserHandle;</div><div>import android.service.dreams.DreamService;</div><div>import android.util.DisplayMetrics;</div><div>import android.util.EventLog;</div><div>import android.util.Log;</div><div>import android.util.Slog;</div><div>import android.view.WindowManager;</div><div>import android.webkit.WebViewFactory;</div><div><br/></div><div>import com.android.internal.R;</div><div>import com.android.internal.os.BinderInternal;</div><div>import com.android.internal.os.Zygote;</div><div>import com.android.internal.os.SamplingProfilerIntegration;</div><div>import com.android.server.accessibility.AccessibilityManagerService;</div><div>import com.android.server.accounts.AccountManagerService;</div><div>import com.android.server.am.ActivityManagerService;</div><div>import com.android.server.am.BatteryStatsService;</div><div>import com.android.server.clipboard.ClipboardService;</div><div>import com.android.server.content.ContentService;</div><div>import com.android.server.devicepolicy.DevicePolicyManagerService;</div><div>import com.android.server.display.DisplayManagerService;</div><div>import com.android.server.dreams.DreamManagerService;</div><div>import com.android.server.fingerprint.FingerprintService;</div><div>import com.android.server.hdmi.HdmiControlService;</div><div>import com.android.server.input.InputManagerService;</div><div>import com.android.server.job.JobSchedulerService;</div><div>import com.android.server.lights.LightsManager;</div><div>import com.android.server.lights.LightsService;</div><div>import com.android.server.media.MediaRouterService;</div><div>import com.android.server.media.MediaSessionService;</div><div>import com.android.server.media.projection.MediaProjectionManagerService;</div><div>import com.android.server.net.NetworkPolicyManagerService;</div><div>import com.android.server.net.NetworkStatsService;</div><div>import com.android.server.notification.NotificationManagerService;</div><div>import com.android.server.os.SchedulingPolicyService;</div><div>import com.android.server.pm.BackgroundDexOptService;</div><div>import com.android.server.pm.Installer;</div><div>import com.android.server.pm.LauncherAppsService;</div><div>import com.android.server.pm.PackageManagerService;</div><div>import com.android.server.pm.UserManagerService;</div><div>import com.android.server.power.PowerManagerService;</div><div>import com.android.server.power.ShutdownThread;</div><div>import com.android.server.restrictions.RestrictionsManagerService;</div><div>import com.android.server.search.SearchManagerService;</div><div>import com.android.server.statusbar.StatusBarManagerService;</div><div>import com.android.server.storage.DeviceStorageMonitorService;</div><div>import com.android.server.telecom.TelecomLoaderService;</div><div>import com.android.server.trust.TrustManagerService;</div><div>import com.android.server.tv.TvInputManagerService;</div><div>import com.android.server.twilight.TwilightService;</div><div>import com.android.server.usage.UsageStatsService;</div><div>import com.android.server.usb.UsbService;</div><div>import com.android.server.wallpaper.WallpaperManagerService;</div><div>import com.android.server.webkit.WebViewUpdateService;</div><div>import com.android.server.wm.WindowManagerService;</div><div>//import com.android.server.TouchSensorService;</div><div>import dalvik.system.VMRuntime;</div><div><br/></div><div>import java.io.File;</div><div>import java.util.Timer;</div><div>import java.util.TimerTask;</div><div><br/></div><div>/// M: Add For BOOTPROF LOG @{</div><div>import java.io.IOException;</div><div>import java.io.FileOutputStream;</div><div>import java.io.FileNotFoundException;</div><div>/// @}</div><div><br/></div><div>/// M: MSG Logger Manager @{</div><div>import com.mediatek.msglogger.MessageMonitorService;</div><div>/// MSG Logger Manager @}</div><div><br/></div><div>/// M: Add AudioProfile service</div><div>import com.mediatek.audioprofile.AudioProfileService;</div><div><br/></div><div>/// M: Add SensorHubService @{</div><div>import com.mediatek.sensorhub.ISensorHubManager;</div><div>import com.mediatek.sensorhub.SensorHubService;</div><div>/// @}</div><div>/// M: Add SearchEngine service</div><div>import com.mediatek.search.SearchEngineManagerService;</div><div>/// @}</div><div>/// M: add for PerfService feature @{</div><div>import com.mediatek.perfservice.IPerfService;</div><div>import com.mediatek.perfservice.IPerfServiceManager;</div><div>import com.mediatek.perfservice.PerfServiceImpl;</div><div>import com.mediatek.perfservice.PerfServiceManager;</div><div>/// @}</div><div>/// M: add for Mobile Manager Service @{</div><div>import com.mediatek.common.mom.MobileManagerUtils;</div><div>import com.mediatek.mom.MobileManagerService;</div><div>/// @}</div><div><br/></div><div>/// M: RecoveryManagerService @{</div><div>import com.mediatek.recovery.RecoveryManagerService;</div><div>/// @}</div><div><br/></div><div>/// M: add for hdmi feature @{</div><div>import com.mediatek.hdmi.MtkHdmiManagerService;</div><div>/// @}</div><div><br/></div><div>public final class SystemServer {</div><div>    private static final String TAG = &quot;SystemServer&quot;;</div><div><br/></div><div>    private static final String ENCRYPTING_STATE = &quot;trigger_restart_min_framework&quot;;</div><div>    private static final String ENCRYPTED_STATE = &quot;1&quot;;</div><div><br/></div><div>    private static final long SNAPSHOT_INTERVAL = 60 * 60 * 1000; // 1hr</div><div><br/></div><div>    // The earliest supported time.  We pick one day into 1970, to</div><div>    // give any timezone code room without going into negative time.</div><div>    private static final long EARLIEST_SUPPORTED_TIME = 86400 * 1000;</div><div><br/></div><div>    /*</div><div>     * Implementation class names. TODO: Move them to a codegen class or load</div><div>     * them from the build system somehow.</div><div>     */</div><div>    private static final String BACKUP_MANAGER_SERVICE_CLASS =</div><div>            &quot;com.android.server.backup.BackupManagerService$Lifecycle&quot;;</div><div>    private static final String APPWIDGET_SERVICE_CLASS =</div><div>            &quot;com.android.server.appwidget.AppWidgetService&quot;;</div><div>    private static final String VOICE_RECOGNITION_MANAGER_SERVICE_CLASS =</div><div>            &quot;com.android.server.voiceinteraction.VoiceInteractionManagerService&quot;;</div><div>    private static final String PRINT_MANAGER_SERVICE_CLASS =</div><div>            &quot;com.android.server.print.PrintManagerService&quot;;</div><div>    private static final String USB_SERVICE_CLASS =</div><div>            &quot;com.android.server.usb.UsbService$Lifecycle&quot;;</div><div>    private static final String WIFI_SERVICE_CLASS =</div><div>            &quot;com.android.server.wifi.WifiService&quot;;</div><div>    private static final String WIFI_P2P_SERVICE_CLASS =</div><div>            &quot;com.android.server.wifi.p2p.WifiP2pService&quot;;</div><div>    private static final String ETHERNET_SERVICE_CLASS =</div><div>            &quot;com.android.server.ethernet.EthernetService&quot;;</div><div>    private static final String JOB_SCHEDULER_SERVICE_CLASS =</div><div>            &quot;com.android.server.job.JobSchedulerService&quot;;</div><div>    private static final String PERSISTENT_DATA_BLOCK_PROP = &quot;ro.frp.pst&quot;;</div><div><br/></div><div>    ///M: Add for EPDG service</div><div>    private static final String EPDG_SERVICE_CLASS =</div><div>            &quot;com.mediatek.epdg.EpdgService&quot;;</div><div>    ///M: Add for Rns service</div><div>    private static final String RNS_SERVICE_CLASS =</div><div>            &quot;com.mediatek.rns.RnsService&quot;;</div><div><br/></div><div>    private final int mFactoryTestMode;</div><div>    private Timer mProfilerSnapshotTimer;</div><div><br/></div><div>    private Context mSystemContext;</div><div>    private SystemServiceManager mSystemServiceManager;</div><div><br/></div><div>    // TODO: remove all of these references by improving dependency resolution and boot phases</div><div>    private PowerManagerService mPowerManagerService;</div><div>    private ActivityManagerService mActivityManagerService;</div><div>    private DisplayManagerService mDisplayManagerService;</div><div>    private PackageManagerService mPackageManagerService;</div><div>    private PackageManager mPackageManager;</div><div>    private ContentResolver mContentResolver;</div><div><br/></div><div>    private boolean mOnlyCore;</div><div>    private boolean mFirstBoot;</div><div><br/></div><div>    /// M: add for Recovery Manager Service</div><div>    private RecoveryManagerService mRecoveryManagerService;</div><div><br/></div><div>    /// M: For BOOTPROF LOG</div><div>    static boolean mMTPROF_disable;</div><div><br/></div><div>    /// M: MSG Logger Manager</div><div>    private static final boolean IS_USER_BUILD = &quot;user&quot;.equals(Build.TYPE) || &quot;userdebug&quot;.equals(Build.TYPE);</div><div><br/></div><div>    /**</div><div>     * Called to initialize native system services.</div><div>     */</div><div>    private static native void nativeInit();</div><div><br/></div><div>    /**</div><div>     * The main entry point from zygote.</div><div>     */</div><div>    public static void main(String[] args) {</div><div>        new SystemServer().run();</div><div>    }</div><div><br/></div><div>    public SystemServer() {</div><div>        // Check for factory test mode.</div><div>        mFactoryTestMode = FactoryTest.getMode();</div><div>    }</div><div><br/></div><div>    private void run() {</div><div>        // If a device's clock is before 1970 (before 0), a lot of</div><div>        // APIs crash dealing with negative numbers, notably</div><div>        // java.io.File#setLastModified, so instead we fake it and</div><div>        // hope that time from cell towers or NTP fixes it shortly.</div><div>        if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) {</div><div>            Slog.w(TAG, &quot;System clock is before 1970; setting to 1970.&quot;);</div><div>            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</div><div>        }</div><div><br/></div><div>        // Here we go!</div><div>        Slog.i(TAG, &quot;Entered the Android system server!&quot;);</div><div>        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, SystemClock.uptimeMillis());</div><div><br/></div><div>        /// M: BOOTPROF @{</div><div>        mMTPROF_disable = &quot;1&quot;.equals(SystemProperties.get(&quot;ro.mtprof.disable&quot;));</div><div>        addBootEvent(new String(&quot;Android:SysServerInit_START&quot;));</div><div>        /// @}</div><div><br/></div><div>        // In case the runtime switched since last boot (such as when</div><div>        // the old runtime was removed in an OTA), set the system</div><div>        // property so that it is in sync. We can't do this in</div><div>        // libnativehelper's JniInvocation::Init code where we already</div><div>        // had to fallback to a different runtime because it is</div><div>        // running as root and we need to be the system user to set</div><div>        // the property. http://b/11463182</div><div>        SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;, VMRuntime.getRuntime().vmLibrary());</div><div><br/></div><div>        // Enable the sampling profiler.</div><div>        if (SamplingProfilerIntegration.isEnabled()) {</div><div>            SamplingProfilerIntegration.start();</div><div>            mProfilerSnapshotTimer = new Timer();</div><div>            mProfilerSnapshotTimer.schedule(new TimerTask() {</div><div>                @Override</div><div>                public void run() {</div><div>                    SamplingProfilerIntegration.writeSnapshot(&quot;system_server&quot;, null);</div><div>                }</div><div>            }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</div><div>        }</div><div><br/></div><div>        // Mmmmmm... more memory!</div><div>        VMRuntime.getRuntime().clearGrowthLimit();</div><div><br/></div><div>        // The system server has to run all of the time, so it needs to be</div><div>        // as efficient as possible with its memory usage.</div><div>        VMRuntime.getRuntime().setTargetHeapUtilization(0.8f);</div><div><br/></div><div>        // Some devices rely on runtime fingerprint generation, so make sure</div><div>        // we've defined it before booting further.</div><div>        Build.ensureFingerprintProperty();</div><div><br/></div><div>        // Within the system server, it is an error to access Environment paths without</div><div>        // explicitly specifying a user.</div><div>        Environment.setUserRequired(true);</div><div><br/></div><div>        // Ensure binder calls into the system always run at foreground priority.</div><div>        BinderInternal.disableBackgroundScheduling(true);</div><div><br/></div><div>        // Prepare the main looper thread (this thread).</div><div>        android.os.Process.setThreadPriority(</div><div>                android.os.Process.THREAD_PRIORITY_FOREGROUND);</div><div>        android.os.Process.setCanSelfBackground(false);</div><div>        Looper.prepareMainLooper();</div><div><br/></div><div>        // Initialize native services.</div><div>        System.loadLibrary(&quot;android_servers&quot;);</div><div>        nativeInit();</div><div><br/></div><div>        ///M:Add for low storage feature,to delete the reserver file.@{</div><div>        try {</div><div>            Runtime.getRuntime().exec(&quot;rm -r /data/piggybank&quot;);</div><div>        } catch (IOException e) {</div><div>            Slog.e(TAG, &quot;system server init delete piggybank fail&quot; + e);</div><div>        }</div><div>        ///@}</div><div><br/></div><div>        // Check whether we failed to shut down last time we tried.</div><div>        // This call may not return.</div><div>        performPendingShutdown();</div><div><br/></div><div>        // Initialize the system context.</div><div>        createSystemContext();</div><div><br/></div><div>        // Create the system service manager.</div><div>        mSystemServiceManager = new SystemServiceManager(mSystemContext);</div><div>        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</div><div><br/></div><div>        // Start services.</div><div>        try {</div><div>            startBootstrapServices();</div><div>            startCoreServices();</div><div>            startOtherServices();</div><div>        } catch (Throwable ex) {</div><div>            Slog.e(&quot;System&quot;, &quot;******************************************&quot;);</div><div>            Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</div><div>            /// M: RecoveryManagerService  @{</div><div>            if (mRecoveryManagerService != null &amp;&amp; ex instanceof RuntimeException) {</div><div>                mRecoveryManagerService.handleException((RuntimeException)ex, true);</div><div>            }</div><div>            /// @}</div><div>        }</div><div><br/></div><div>        // For debug builds, log event loop stalls to dropbox for analysis.</div><div>        if (StrictMode.conditionallyEnableDebugLogging()) {</div><div>            Slog.i(TAG, &quot;Enabled StrictMode for system server main thread.&quot;);</div><div>        }</div><div><br/></div><div>        /// M: BOOTPROF</div><div>        addBootEvent(new String(&quot;Android:SysServerInit_END&quot;));</div><div><br/></div><div>        // Loop forever.</div><div>        Looper.loop();</div><div>        throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</div><div>    }</div><div><br/></div><div>    private void reportWtf(String msg, Throwable e) {</div><div>        Slog.w(TAG, &quot;***********************************************&quot;);</div><div>        Slog.wtf(TAG, &quot;BOOT FAILURE &quot; + msg, e);</div><div>    }</div><div><br/></div><div>    /// M: Add BOOTPROF LOG @{</div><div>    public static void addBootEvent(String bootevent) {</div><div>        try {</div><div>            if (!mMTPROF_disable) {</div><div>                FileOutputStream fbp = new FileOutputStream(&quot;/proc/bootprof&quot;);</div><div>                fbp.write(bootevent.getBytes());</div><div>                fbp.flush();</div><div>                fbp.close();</div><div>            }</div><div>        } catch (FileNotFoundException e) {</div><div>            Slog.e(&quot;BOOTPROF&quot;, &quot;Failure open /proc/bootprof, not found!&quot;, e);</div><div>        } catch (java.io.IOException e) {</div><div>            Slog.e(&quot;BOOTPROF&quot;, &quot;Failure open /proc/bootprof entry&quot;, e);</div><div>        }</div><div>    }</div><div>    /// @}</div><div><br/></div><div>    private void performPendingShutdown() {</div><div>        final String shutdownAction = SystemProperties.get(</div><div>                ShutdownThread.SHUTDOWN_ACTION_PROPERTY, &quot;&quot;);</div><div>        if (shutdownAction != null &amp;&amp; shutdownAction.length() &gt; 0) {</div><div>            boolean reboot = (shutdownAction.charAt(0) == '1');</div><div><br/></div><div>            final String reason;</div><div>            if (shutdownAction.length() &gt; 1) {</div><div>                reason = shutdownAction.substring(1, shutdownAction.length());</div><div>            } else {</div><div>                reason = null;</div><div>            }</div><div><br/></div><div>            ShutdownThread.rebootOrShutdown(reboot, reason);</div><div>        }</div><div>    }</div><div><br/></div><div>    private void createSystemContext() {</div><div>        ActivityThread activityThread = ActivityThread.systemMain();</div><div>        mSystemContext = activityThread.getSystemContext();</div><div>        mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Starts the small tangle of critical services that are needed to get</div><div>     * the system off the ground.  These services have complex mutual dependencies</div><div>     * which is why we initialize them all in one place here.  Unless your service</div><div>     * is also entwined in these dependencies, it should be initialized in one of</div><div>     * the other functions.</div><div>     */</div><div>    private void startBootstrapServices() {</div><div>        // Wait for installd to finish starting up so that it has a chance to</div><div>        // create critical directories such as /data/user with the appropriate</div><div>        // permissions.  We need this to complete before we initialize other services.</div><div>        Installer installer = mSystemServiceManager.startService(Installer.class);</div><div><br/></div><div>        /// M: MSG Logger Manager @{</div><div>        if (!IS_USER_BUILD) {</div><div>            try {</div><div>                MessageMonitorService msgMonitorService = null;</div><div>                msgMonitorService = new MessageMonitorService();</div><div>                Slog.e(TAG, &quot;Create message monitor service successfully .&quot;);</div><div><br/></div><div>                // Add this service to service manager</div><div>                ServiceManager.addService(Context.MESSAGE_MONITOR_SERVICE, msgMonitorService.asBinder());</div><div>            } catch (Throwable e) {</div><div>                Slog.e(TAG, &quot;Starting message monitor service exception &quot;, e);</div><div>            }</div><div>        }</div><div>        /// MSG Logger Manager @}</div><div><br/></div><div>        // Activity manager runs the show.</div><div>        mActivityManagerService = mSystemServiceManager.startService(</div><div>                ActivityManagerService.Lifecycle.class).getService();</div><div>        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</div><div>        mActivityManagerService.setInstaller(installer);</div><div><br/></div><div>        // Power manager needs to be started early because other services need it.</div><div>        // Native daemons may be watching for it to be registered so it must be ready</div><div>        // to handle incoming binder calls immediately (including being able to verify</div><div>        // the permissions for those calls).</div><div>        mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</div><div><br/></div><div>        // Now that the power manager has been started, let the activity manager</div><div>        // initialize power management features.</div><div>        mActivityManagerService.initPowerManagement();</div><div><br/></div><div>        // Display manager is needed to provide display metrics before package manager</div><div>        // starts up.</div><div>        mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</div><div><br/></div><div>        // We need the default display before we can initialize the package manager.</div><div>        mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</div><div><br/></div><div>        // Only run &quot;core&quot; apps if we're encrypting the device.</div><div>        String cryptState = SystemProperties.get(&quot;vold.decrypt&quot;);</div><div>        if (ENCRYPTING_STATE.equals(cryptState)) {</div><div>            Slog.w(TAG, &quot;Detected encryption in progress - only parsing core apps&quot;);</div><div>            mOnlyCore = true;</div><div>        } else if (ENCRYPTED_STATE.equals(cryptState)) {</div><div>            Slog.w(TAG, &quot;Device encrypted - only parsing core apps&quot;);</div><div>            mOnlyCore = true;</div><div>        }</div><div><br/></div><div>        /// M: RecoveryManagerService  @{</div><div>        boolean disabled = &quot;0&quot;.equals(SystemProperties.get(&quot;ro.mtk_antibricking_level&quot;));</div><div>        if (!disabled) {</div><div>            try {</div><div>                Slog.i(TAG, &quot;Recovery Manager&quot;);</div><div>                mRecoveryManagerService = new RecoveryManagerService(mSystemContext);</div><div>                if (mRecoveryManagerService != null) {</div><div>                    ServiceManager.addService(Context.RECOVERY_SERVICE, mRecoveryManagerService.asBinder());</div><div>                    mRecoveryManagerService.startBootMonitor();</div><div>                }</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;Failure starting Recovery Manager&quot;, e);</div><div>            }</div><div>        }</div><div>        /// @}</div><div><br/></div><div>        // Start the package manager.</div><div>        Slog.i(TAG, &quot;Package Manager&quot;);</div><div>        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</div><div>        mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</div><div>        mFirstBoot = mPackageManagerService.isFirstBoot();</div><div>        mPackageManager = mSystemContext.getPackageManager();</div><div><br/></div><div>        Slog.i(TAG, &quot;User Service&quot;);</div><div>        ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance());</div><div><br/></div><div>        // Initialize attribute cache used to cache resources from packages.</div><div>        AttributeCache.init(mSystemContext);</div><div><br/></div><div>        // Set up the Application instance for the system process and get started.</div><div>        mActivityManagerService.setSystemProcess();</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Starts some essential services that are not tangled up in the bootstrap process.</div><div>     */</div><div>    private void startCoreServices() {</div><div>        // Manages LEDs and display backlight.</div><div>        mSystemServiceManager.startService(LightsService.class);</div><div><br/></div><div>        // Tracks the battery level.  Requires LightService.</div><div>        mSystemServiceManager.startService(BatteryService.class);</div><div><br/></div><div><br/></div><div>        // Tracks application usage stats.</div><div>        mSystemServiceManager.startService(UsageStatsService.class);</div><div>        mActivityManagerService.setUsageStatsManager(</div><div>                LocalServices.getService(UsageStatsManagerInternal.class));</div><div>        // Update after UsageStatsService is available, needed before performBootDexOpt.</div><div>        mPackageManagerService.getUsageStatsIfNoPackageUsageInfo();</div><div><br/></div><div>        // Tracks whether the updatable WebView is in a ready state and watches for update installs.</div><div>        mSystemServiceManager.startService(WebViewUpdateService.class);</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Starts a miscellaneous grab bag of stuff that has yet to be refactored</div><div>     * and organized.</div><div>     */</div><div>    private void startOtherServices() {</div><div>        final Context context = mSystemContext;</div><div>        AccountManagerService accountManager = null;</div><div>        ContentService contentService = null;</div><div>        VibratorService vibrator = null;</div><div>        IAlarmManager alarm = null;</div><div>        MountService mountService = null;</div><div>        NetworkManagementService networkManagement = null;</div><div>        NetworkStatsService networkStats = null;</div><div>        NetworkPolicyManagerService networkPolicy = null;</div><div>        ConnectivityService connectivity = null;</div><div>        NetworkScoreService networkScore = null;</div><div>        NsdService serviceDiscovery= null;</div><div>        WindowManagerService wm = null;</div><div>        BluetoothManagerService bluetooth = null;</div><div>        UsbService usb = null;</div><div>        SerialService serial = null;</div><div>        NetworkTimeUpdateService networkTimeUpdater = null;</div><div>        CommonTimeManagementService commonTimeMgmtService = null;</div><div>        InputManagerService inputManager = null;</div><div>        TelephonyRegistry telephonyRegistry = null;</div><div>        ConsumerIrService consumerIr = null;</div><div>        AudioService audioService = null;</div><div>        MmsServiceBroker mmsService = null;</div><div><br/></div><div>        /// M: add for Mobile Manager Service</div><div>        MobileManagerService mom = null;</div><div>        /// M: add for hdmi feature</div><div>        MtkHdmiManagerService hdmiManager = null;</div><div><br/></div><div>        boolean disableStorage = SystemProperties.getBoolean(&quot;config.disable_storage&quot;, false);</div><div>        boolean disableMedia = SystemProperties.getBoolean(&quot;config.disable_media&quot;, false);</div><div>        boolean disableBluetooth = SystemProperties.getBoolean(&quot;config.disable_bluetooth&quot;, false);</div><div>        boolean disableTelephony = SystemProperties.getBoolean(&quot;config.disable_telephony&quot;, false);</div><div>        boolean disableLocation = SystemProperties.getBoolean(&quot;config.disable_location&quot;, false);</div><div>        boolean disableSystemUI = SystemProperties.getBoolean(&quot;config.disable_systemui&quot;, false);</div><div>        boolean disableNonCoreServices = SystemProperties.getBoolean(&quot;config.disable_noncore&quot;, false);</div><div>        boolean disableNetwork = SystemProperties.getBoolean(&quot;config.disable_network&quot;, false);</div><div>        boolean disableNetworkTime = SystemProperties.getBoolean(&quot;config.disable_networktime&quot;, false);</div><div>        boolean isEmulator = SystemProperties.get(&quot;ro.kernel.qemu&quot;).equals(&quot;1&quot;);</div><div><br/></div><div>        try {</div><div><br/></div><div>            Slog.i(TAG, &quot;Reading configuration...&quot;);</div><div>            SystemConfig.getInstance();</div><div><br/></div><div>            Slog.i(TAG, &quot;Scheduling Policy&quot;);</div><div>            ServiceManager.addService(&quot;scheduling_policy&quot;, new SchedulingPolicyService());</div><div><br/></div><div>            mSystemServiceManager.startService(TelecomLoaderService.class);</div><div><br/></div><div>            Slog.i(TAG, &quot;Telephony Registry&quot;);</div><div>            telephonyRegistry = new TelephonyRegistry(context);</div><div>            ServiceManager.addService(&quot;telephony.registry&quot;, telephonyRegistry);</div><div><br/></div><div>            Slog.i(TAG, &quot;Entropy Mixer&quot;);</div><div>            ServiceManager.addService(&quot;entropy&quot;, new EntropyMixer(context));</div><div><br/></div><div>            mContentResolver = context.getContentResolver();</div><div><br/></div><div>            // The AccountManager must come before the ContentService</div><div>            try {</div><div>                // TODO: seems like this should be disable-able, but req'd by ContentService</div><div>                Slog.i(TAG, &quot;Account Manager&quot;);</div><div>                accountManager = new AccountManagerService(context);</div><div>                ServiceManager.addService(Context.ACCOUNT_SERVICE, accountManager);</div><div>            } catch (Throwable e) {</div><div>                Slog.e(TAG, &quot;Failure starting Account Manager&quot;, e);</div><div>            }</div><div><br/></div><div>            Slog.i(TAG, &quot;Content Manager&quot;);</div><div>            contentService = ContentService.main(context,</div><div>                    mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL);</div><div><br/></div><div>            /// M: Mobile Manager Service must after PMS and before first permission checking @{</div><div>            if (MobileManagerUtils.isSupported()) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;MobileManagerService&quot;);</div><div>                    mom = new MobileManagerService(context);</div><div>                    ServiceManager.addService(Context.MOBILE_SERVICE, mom.asBinder());</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Failure creating MobileManagerService&quot;, e);</div><div>                }</div><div>            }</div><div>            ///@}</div><div><br/></div><div>            Slog.i(TAG, &quot;System Content Providers&quot;);</div><div>            mActivityManagerService.installSystemProviders();</div><div><br/></div><div>            Slog.i(TAG, &quot;Vibrator Service&quot;);</div><div>            vibrator = new VibratorService(context);</div><div>            ServiceManager.addService(&quot;vibrator&quot;, vibrator);</div><div><br/></div><div>            Slog.i(TAG, &quot;Consumer IR Service&quot;);</div><div>            consumerIr = new ConsumerIrService(context);</div><div>            ServiceManager.addService(Context.CONSUMER_IR_SERVICE, consumerIr);</div><div><br/></div><div>            mSystemServiceManager.startService(AlarmManagerService.class);</div><div>            alarm = IAlarmManager.Stub.asInterface(</div><div>                    ServiceManager.getService(Context.ALARM_SERVICE));</div><div><br/></div><div>            Slog.i(TAG, &quot;Init Watchdog&quot;);</div><div>            final Watchdog watchdog = Watchdog.getInstance();</div><div>            watchdog.init(context, mActivityManagerService);</div><div><br/></div><div>            Slog.i(TAG, &quot;Input Manager&quot;);</div><div>            inputManager = new InputManagerService(context);</div><div><br/></div><div>            Slog.i(TAG, &quot;Window Manager&quot;);</div><div>            wm = WindowManagerService.main(context, inputManager,</div><div>                    mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</div><div>                    !mFirstBoot, mOnlyCore);</div><div>            ServiceManager.addService(Context.WINDOW_SERVICE, wm);</div><div>            ServiceManager.addService(Context.INPUT_SERVICE, inputManager);</div><div><br/></div><div>            mActivityManagerService.setWindowManager(wm);</div><div><br/></div><div>            inputManager.setWindowManagerCallbacks(wm.getInputMonitor());</div><div>            inputManager.start();</div><div><br/></div><div>            // TODO: Use service dependencies instead.</div><div>            mDisplayManagerService.windowManagerAndInputReady();</div><div><br/></div><div>            // Skip Bluetooth if we have an emulator kernel</div><div>            // TODO: Use a more reliable check to see if this product should</div><div>            // support Bluetooth - see bug 988521</div><div>            if (isEmulator) {</div><div>                Slog.i(TAG, &quot;No Bluetooh Service (emulator)&quot;);</div><div>            } else if (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) {</div><div>                Slog.i(TAG, &quot;No Bluetooth Service (factory test)&quot;);</div><div>            } else if (!context.getPackageManager().hasSystemFeature</div><div>                       (PackageManager.FEATURE_BLUETOOTH)) {</div><div>                Slog.i(TAG, &quot;No Bluetooth Service (Bluetooth Hardware Not Present)&quot;);</div><div>            } else if (disableBluetooth) {</div><div>                Slog.i(TAG, &quot;Bluetooth Service disabled by config&quot;);</div><div>            } else {</div><div>                Slog.i(TAG, &quot;Bluetooth Manager Service&quot;);</div><div>                bluetooth = new BluetoothManagerService(context);</div><div>                ServiceManager.addService(BluetoothAdapter.BLUETOOTH_MANAGER_SERVICE, bluetooth);</div><div>            }</div><div>        } catch (RuntimeException e) {</div><div>            Slog.e(&quot;System&quot;, &quot;******************************************&quot;);</div><div>            Slog.e(&quot;System&quot;, &quot;************ Failure starting core service&quot;, e);</div><div>            /** M: Recovery Manager still try to recover the exception,</div><div>                      even if the exception currently not cuase boot failure  @{ */</div><div>            if (mRecoveryManagerService != null) {</div><div>                mRecoveryManagerService.handleException(e, false);</div><div>            }</div><div>            /** @} */</div><div>        }</div><div><br/></div><div>        StatusBarManagerService statusBar = null;</div><div>        INotificationManager notification = null;</div><div>        InputMethodManagerService imm = null;</div><div>        WallpaperManagerService wallpaper = null;</div><div>        LocationManagerService location = null;</div><div>        CountryDetectorService countryDetector = null;</div><div>        TextServicesManagerService tsms = null;</div><div>        LockSettingsService lockSettings = null;</div><div>        PerfMgrStateNotifier perfMgrNotifier = null;</div><div>        IPerfServiceManager perfServiceMgr = null;</div><div>        AssetAtlasService atlas = null;</div><div>        MediaRouterService mediaRouter = null;</div><div><br/></div><div>        // Bring up services needed for UI.</div><div>        if (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) {</div><div>            //if (!disableNonCoreServices) { // TODO: View depends on these; mock them?</div><div>            if (true) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Input Method Service&quot;);</div><div>                    imm = new InputMethodManagerService(context, wm);</div><div>                    ServiceManager.addService(Context.INPUT_METHOD_SERVICE, imm);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Input Manager Service&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;Accessibility Manager&quot;);</div><div>                    ServiceManager.addService(Context.ACCESSIBILITY_SERVICE,</div><div>                            new AccessibilityManagerService(context));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Accessibility Manager&quot;, e);</div><div>                }</div><div>            }</div><div>        }</div><div><br/></div><div>        try {</div><div>            wm.displayReady();</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making display ready&quot;, e);</div><div>        }</div><div><br/></div><div>        if (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) {</div><div>            if (!disableStorage &amp;&amp;</div><div>                !&quot;0&quot;.equals(SystemProperties.get(&quot;system_init.startmountservice&quot;))) {</div><div>                try {</div><div>                    /*</div><div>                     * NotificationManagerService is dependant on MountService,</div><div>                     * (for media / usb notifications) so we must start MountService first.</div><div>                     */</div><div>                    Slog.i(TAG, &quot;Mount Service&quot;);</div><div>                    mountService = new MountService(context);</div><div>                    ServiceManager.addService(&quot;mount&quot;, mountService);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Mount Service&quot;, e);</div><div>                }</div><div>            }</div><div>        }</div><div><br/></div><div>        try {</div><div>            mPackageManagerService.performBootDexOpt();</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;performing boot dexopt&quot;, e);</div><div>        }</div><div><br/></div><div>        try {</div><div>            ActivityManagerNative.getDefault().showBootMessage(</div><div>                    context.getResources().getText(</div><div>                            com.android.internal.R.string.android_upgrading_starting_apps),</div><div>                    false);</div><div>        } catch (RemoteException e) {</div><div>        }</div><div><br/></div><div>        if (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) {</div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG,  &quot;LockSettingsService&quot;);</div><div>                    lockSettings = new LockSettingsService(context);</div><div>                    ServiceManager.addService(&quot;lock_settings&quot;, lockSettings);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting LockSettingsService service&quot;, e);</div><div>                }</div><div><br/></div><div>                if (!SystemProperties.get(PERSISTENT_DATA_BLOCK_PROP).equals(&quot;&quot;)) {</div><div>                    mSystemServiceManager.startService(PersistentDataBlockService.class);</div><div>                }</div><div><br/></div><div>                // Always start the Device Policy Manager, so that the API is compatible with</div><div>                // API8.</div><div>                mSystemServiceManager.startService(DevicePolicyManagerService.Lifecycle.class);</div><div>            }</div><div><br/></div><div>            if (!disableSystemUI) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Status Bar&quot;);</div><div>                    statusBar = new StatusBarManagerService(context, wm);</div><div>                    ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting StatusBarManagerService&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Clipboard Service&quot;);</div><div>                    ServiceManager.addService(Context.CLIPBOARD_SERVICE,</div><div>                            new ClipboardService(context));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Clipboard Service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNetwork) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;NetworkManagement Service&quot;);</div><div>                    networkManagement = NetworkManagementService.create(context);</div><div>                    ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting NetworkManagement Service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Text Service Manager Service&quot;);</div><div>                    tsms = new TextServicesManagerService(context);</div><div>                    ServiceManager.addService(Context.TEXT_SERVICES_MANAGER_SERVICE, tsms);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Text Service Manager Service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNetwork) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Network Score Service&quot;);</div><div>                    networkScore = new NetworkScoreService(context);</div><div>                    ServiceManager.addService(Context.NETWORK_SCORE_SERVICE, networkScore);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Network Score Service&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;NetworkStats Service&quot;);</div><div>                    networkStats = new NetworkStatsService(context, networkManagement, alarm);</div><div>                    ServiceManager.addService(Context.NETWORK_STATS_SERVICE, networkStats);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting NetworkStats Service&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;NetworkPolicy Service&quot;);</div><div>                    networkPolicy = new NetworkPolicyManagerService(</div><div>                            context, mActivityManagerService,</div><div>                            (IPowerManager)ServiceManager.getService(Context.POWER_SERVICE),</div><div>                            networkStats, networkManagement);</div><div>                    ServiceManager.addService(Context.NETWORK_POLICY_SERVICE, networkPolicy);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting NetworkPolicy Service&quot;, e);</div><div>                }</div><div><br/></div><div>                mSystemServiceManager.startService(WIFI_P2P_SERVICE_CLASS);</div><div>                mSystemServiceManager.startService(WIFI_SERVICE_CLASS);</div><div>                mSystemServiceManager.startService(</div><div>                            &quot;com.android.server.wifi.WifiScanningService&quot;);</div><div><br/></div><div>                mSystemServiceManager.startService(&quot;com.android.server.wifi.RttService&quot;);</div><div><br/></div><div>                if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_ETHERNET)) {</div><div>                    mSystemServiceManager.startService(ETHERNET_SERVICE_CLASS);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;Connectivity Service&quot;);</div><div>                    connectivity = new ConnectivityService(</div><div>                            context, networkManagement, networkStats, networkPolicy);</div><div>                    ServiceManager.addService(Context.CONNECTIVITY_SERVICE, connectivity);</div><div>                    networkStats.bindConnectivityManager(connectivity);</div><div>                    networkPolicy.bindConnectivityManager(connectivity);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Connectivity Service&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;Network Service Discovery Service&quot;);</div><div>                    serviceDiscovery = NsdService.create(context);</div><div>                    ServiceManager.addService(</div><div>                            Context.NSD_SERVICE, serviceDiscovery);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Service Discovery Service&quot;, e);</div><div>                }</div><div><br/></div><div>                ///M: Start EPDG service @{</div><div>                if (&quot;1&quot;.equals(SystemProperties.get(&quot;ro.mtk_epdg_support&quot;))) {</div><div>                    try {</div><div>                        Slog.i(TAG, &quot;EPDG Service&quot;);</div><div>                        mSystemServiceManager.startService(EPDG_SERVICE_CLASS);</div><div>                    } catch (Throwable e) {</div><div>                        Slog.e(TAG, &quot;Can't start EPDG service:&quot; + e);</div><div>                    }</div><div>                }</div><div>                /// @}</div><div>                /// M: Start Rns service @{</div><div>                if (&quot;1&quot;.equals(SystemProperties.get(&quot;ro.mtk_epdg_support&quot;))) {</div><div>                    try {</div><div>                        Slog.i(TAG, &quot;RNS Service&quot;);</div><div>                        mSystemServiceManager.startService(RNS_SERVICE_CLASS);</div><div>                    } catch (Throwable e) {</div><div>                        Slog.e(TAG, &quot;Failure starting RNS Service&quot;, e);</div><div>                    }</div><div>                }</div><div>                Slog.i(TAG, &quot;RNS Service_END&quot;);</div><div>                /// @}</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;UpdateLock Service&quot;);</div><div>                    ServiceManager.addService(Context.UPDATE_LOCK_SERVICE,</div><div>                            new UpdateLockService(context));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting UpdateLockService&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            /*</div><div>             * MountService has a few dependencies: Notification Manager and</div><div>             * AppWidget Provider. Make sure MountService is completely started</div><div>             * first before continuing.</div><div>             */</div><div>            if (mountService != null &amp;&amp; !mOnlyCore) {</div><div>                mountService.waitForAsecScan();</div><div>            }</div><div><br/></div><div>            try {</div><div>                if (accountManager != null)</div><div>                    accountManager.systemReady();</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;making Account Manager Service ready&quot;, e);</div><div>            }</div><div><br/></div><div>            try {</div><div>                if (contentService != null)</div><div>                    contentService.systemReady();</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;making Content Service ready&quot;, e);</div><div>            }</div><div><br/></div><div>            mSystemServiceManager.startService(NotificationManagerService.class);</div><div>            notification = INotificationManager.Stub.asInterface(</div><div>                    ServiceManager.getService(Context.NOTIFICATION_SERVICE));</div><div>            networkPolicy.bindNotificationManager(notification);</div><div><br/></div><div>            mSystemServiceManager.startService(DeviceStorageMonitorService.class);</div><div><br/></div><div>            if (!disableLocation) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Location Manager&quot;);</div><div>                    location = new LocationManagerService(context);</div><div>                    ServiceManager.addService(Context.LOCATION_SERVICE, location);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Location Manager&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;Country Detector&quot;);</div><div>                    countryDetector = new CountryDetectorService(context);</div><div>                    ServiceManager.addService(Context.COUNTRY_DETECTOR, countryDetector);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Country Detector&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Search Service&quot;);</div><div>                    ServiceManager.addService(Context.SEARCH_SERVICE,</div><div>                            new SearchManagerService(context));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Search Service&quot;, e);</div><div>                }</div><div><br/></div><div>                /// M: add search engine service @{</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Search Engine Service&quot;);</div><div>                    ServiceManager.addService(Context.SEARCH_ENGINE_SERVICE,</div><div>                                new SearchEngineManagerService(context));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Search Engine Service&quot;, e);</div><div>                }</div><div>                /// @}</div><div>            }</div><div><br/></div><div>            try {</div><div>                Slog.i(TAG, &quot;DropBox Service&quot;);</div><div>                ServiceManager.addService(Context.DROPBOX_SERVICE,</div><div>                        new DropBoxManagerService(context, new File(&quot;/data/system/dropbox&quot;)));</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;starting DropBoxManagerService&quot;, e);</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices &amp;&amp; context.getResources().getBoolean(</div><div>                        R.bool.config_enableWallpaperService)) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Wallpaper Service&quot;);</div><div>                    wallpaper = new WallpaperManagerService(context);</div><div>                    ServiceManager.addService(Context.WALLPAPER_SERVICE, wallpaper);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Wallpaper Service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableMedia &amp;&amp; !&quot;0&quot;.equals(SystemProperties.get(&quot;system_init.startaudioservice&quot;))) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Audio Service&quot;);</div><div>                    audioService = new AudioService(context);</div><div>                    ServiceManager.addService(Context.AUDIO_SERVICE, audioService);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting Audio Service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            /// M: Add AudioProfile service @{</div><div>            // Disable audio profile service in bsp package</div><div>            if (!disableMedia &amp;&amp; false == SystemProperties.get(&quot;ro.mtk_bsp_package&quot;).equals(&quot;1&quot;)</div><div>                    &amp;&amp; true == SystemProperties.get(&quot;ro.mtk_audio_profiles&quot;).equals(&quot;1&quot;)) {</div><div>                try {</div><div>                    Slog.d(TAG, &quot;AudioProfile Service&quot;);</div><div>                    ServiceManager.addService(Context.AUDIO_PROFILE_SERVICE, new AudioProfileService(context));</div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;starting AudioProfile Service&quot;, e);</div><div>                }</div><div>            }</div><div>            ///@}</div><div><br/></div><div>            /// M: Add SensorHubService @{</div><div>            if (&quot;1&quot;.equals(SystemProperties.get(&quot;ro.mtk_sensorhub_support&quot;))) {</div><div>                try {</div><div>                    Slog.d(TAG, &quot;SensorHubService&quot;);</div><div>                    ServiceManager.addService(ISensorHubManager.SENSORHUB_SERVICE, new SensorHubService(context));</div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;starting SensorHub Service&quot;, e);</div><div>                }</div><div>            }</div><div>            ///@}</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                mSystemServiceManager.startService(DockObserver.class);</div><div>            }</div><div><br/></div><div>            if (!disableMedia) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Wired Accessory Manager&quot;);</div><div>                    // Listen for wired headset changes</div><div>                    inputManager.setWiredAccessoryCallbacks(</div><div>                            new WiredAccessoryManager(context, inputManager));</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting WiredAccessoryManager&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_USB_HOST)</div><div>                        || mPackageManager.hasSystemFeature(</div><div>                                PackageManager.FEATURE_USB_ACCESSORY)) {</div><div>                    // Manage USB host and device support</div><div>                    mSystemServiceManager.startService(USB_SERVICE_CLASS);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;Serial Service&quot;);</div><div>                    // Serial port support</div><div>                    serial = new SerialService(context);</div><div>                    ServiceManager.addService(Context.SERIAL_SERVICE, serial);</div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;Failure starting SerialService&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            mSystemServiceManager.startService(TwilightService.class);</div><div><br/></div><div>            mSystemServiceManager.startService(UiModeManagerService.class);</div><div><br/></div><div>            mSystemServiceManager.startService(JobSchedulerService.class);</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_BACKUP)) {</div><div>                    mSystemServiceManager.startService(BACKUP_MANAGER_SERVICE_CLASS);</div><div>                }</div><div><br/></div><div>                if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_APP_WIDGETS)) {</div><div>                    mSystemServiceManager.startService(APPWIDGET_SERVICE_CLASS);</div><div>                }</div><div><br/></div><div>                if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_VOICE_RECOGNIZERS)) {</div><div>                    mSystemServiceManager.startService(VOICE_RECOGNITION_MANAGER_SERVICE_CLASS);</div><div>                }</div><div>            }</div><div><br/></div><div>            try {</div><div>                Slog.i(TAG, &quot;DiskStats Service&quot;);</div><div>                ServiceManager.addService(&quot;diskstats&quot;, new DiskStatsService(context));</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;starting DiskStats Service&quot;, e);</div><div>            }</div><div>           try {</div><div>                Slog.i(TAG, &quot;Motor Service&quot;);</div><div>                ServiceManager.addService(&quot;motor&quot;, new MotorService(context));</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;starting Motor Service&quot;, e);</div><div>            }</div><div><br/></div><div>            try {</div><div>                Slog.i(TAG, &quot;TouchSensor Service&quot;);</div><div>                ServiceManager.addService(&quot;touchsensor&quot;, new TouchSensorService(context));</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;starting TouchSenserService Service&quot;, e);</div><div>            }</div><div><br/></div><div>            try {</div><div>                // need to add this service even if SamplingProfilerIntegration.isEnabled()</div><div>                // is false, because it is this service that detects system property change and</div><div>                // turns on SamplingProfilerIntegration. Plus, when sampling profiler doesn't work,</div><div>                // there is little overhead for running this service.</div><div>                Slog.i(TAG, &quot;SamplingProfiler Service&quot;);</div><div>                ServiceManager.addService(&quot;samplingprofiler&quot;,</div><div>                            new SamplingProfilerService(context));</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;starting SamplingProfiler Service&quot;, e);</div><div>            }</div><div><br/></div><div>            if (!disableNetwork &amp;&amp; !disableNetworkTime) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;NetworkTimeUpdateService&quot;);</div><div>                    networkTimeUpdater = new NetworkTimeUpdateService(context);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting NetworkTimeUpdate service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableMedia) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;CommonTimeManagementService&quot;);</div><div>                    commonTimeMgmtService = new CommonTimeManagementService(context);</div><div>                    ServiceManager.addService(&quot;commontime_management&quot;, commonTimeMgmtService);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting CommonTimeManagementService service&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNetwork) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;CertBlacklister&quot;);</div><div>                    CertBlacklister blacklister = new CertBlacklister(context);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting CertBlacklister&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                // Dreams (interactive idle-time views, a/k/a screen savers, and doze mode)</div><div>                mSystemServiceManager.startService(DreamManagerService.class);</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices &amp;&amp; !SystemProperties.getBoolean(&quot;ro.hwui.disable_asset_atlas&quot;, false)) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Assets Atlas Service&quot;);</div><div>                    atlas = new AssetAtlasService(context);</div><div>                    ServiceManager.addService(AssetAtlasService.ASSET_ATLAS_SERVICE, atlas);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting AssetAtlasService&quot;, e);</div><div>                }</div><div>            }</div><div><br/></div><div>            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_PRINTING)) {</div><div>                mSystemServiceManager.startService(PRINT_MANAGER_SERVICE_CLASS);</div><div>            }</div><div><br/></div><div>            mSystemServiceManager.startService(RestrictionsManagerService.class);</div><div><br/></div><div>            mSystemServiceManager.startService(MediaSessionService.class);</div><div><br/></div><div>            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_HDMI_CEC)) {</div><div>                mSystemServiceManager.startService(HdmiControlService.class);</div><div>            }</div><div><br/></div><div>            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_LIVE_TV)) {</div><div>                mSystemServiceManager.startService(TvInputManagerService.class);</div><div>            }</div><div><br/></div><div>            if (!disableNonCoreServices) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;Media Router Service&quot;);</div><div>                    mediaRouter = new MediaRouterService(context);</div><div>                    ServiceManager.addService(Context.MEDIA_ROUTER_SERVICE, mediaRouter);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting MediaRouterService&quot;, e);</div><div>                }</div><div><br/></div><div>                mSystemServiceManager.startService(TrustManagerService.class);</div><div><br/></div><div>                mSystemServiceManager.startService(FingerprintService.class);</div><div><br/></div><div>                try {</div><div>                    Slog.i(TAG, &quot;BackgroundDexOptService&quot;);</div><div>                    BackgroundDexOptService.schedule(context);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting BackgroundDexOptService&quot;, e);</div><div>                }</div><div><br/></div><div>            }</div><div><br/></div><div>            mSystemServiceManager.startService(LauncherAppsService.class);</div><div><br/></div><div>            /// M: add for PerfService feature @{</div><div>            if (SystemProperties.get(&quot;ro.mtk_perfservice_support&quot;).equals(&quot;1&quot;)) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;PerfMgr state notifier&quot;);</div><div>                    perfMgrNotifier = new PerfMgrStateNotifier();</div><div>                    mActivityManagerService.registerActivityStateNotifier(perfMgrNotifier);</div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;FAIL starting PerfMgrStateNotifier&quot;, e);</div><div>                }</div><div><br/></div><div>                // Create PerfService manager thread and add service</div><div>                try {</div><div>                    perfServiceMgr = new PerfServiceManager(context);</div><div><br/></div><div>                    IPerfService perfService = null;</div><div>                    perfService = new PerfServiceImpl(context, perfServiceMgr);</div><div><br/></div><div>                    Slog.d(&quot;perfservice&quot;, &quot;perfService=&quot; + perfService);</div><div>                    if (perfService != null) {</div><div>                        ServiceManager.addService(Context.MTK_PERF_SERVICE, perfService.asBinder());</div><div>                    }</div><div><br/></div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;perfservice Failure starting PerfService&quot;, e);</div><div>                }</div><div>            }</div><div>            /// @}</div><div><br/></div><div>            /// M: add for HDMI feature @{</div><div>            if (!disableNonCoreServices &amp;&amp; SystemProperties.get(&quot;ro.mtk_hdmi_support&quot;).equals(&quot;1&quot;)) {</div><div>                try {</div><div>                    Slog.i(TAG, &quot;HDMI Manager Service&quot;);</div><div>                    hdmiManager = new MtkHdmiManagerService(context);</div><div>                    ServiceManager.addService(Context.HDMI_SERVICE,</div><div>                            hdmiManager.asBinder());</div><div>                } catch (Throwable e) {</div><div>                    Slog.e(TAG, &quot;Failure starting MtkHdmiManager&quot;, e);</div><div>                }</div><div>            }</div><div>            /// @}</div><div>        }</div><div><br/></div><div>        if (!disableNonCoreServices) {</div><div>            mSystemServiceManager.startService(MediaProjectionManagerService.class);</div><div>        }</div><div><br/></div><div>        // Before things start rolling, be sure we have decided whether</div><div>        // we are in safe mode.</div><div>        final boolean safeMode = wm.detectSafeMode();</div><div>        if (safeMode) {</div><div>            mActivityManagerService.enterSafeMode();</div><div>            // Disable the JIT for the system_server process</div><div>            VMRuntime.getRuntime().disableJitCompilation();</div><div>        } else {</div><div>            // Enable the JIT for the system_server process</div><div>            VMRuntime.getRuntime().startJitCompilation();</div><div>        }</div><div><br/></div><div>        // MMS service broker</div><div>        mmsService = mSystemServiceManager.startService(MmsServiceBroker.class);</div><div><br/></div><div>        // It is now time to start up the app processes...</div><div><br/></div><div>        try {</div><div>            vibrator.systemReady();</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making Vibrator Service ready&quot;, e);</div><div>        }</div><div><br/></div><div>        if (lockSettings != null) {</div><div>            try {</div><div>                lockSettings.systemReady();</div><div>            } catch (Throwable e) {</div><div>                reportWtf(&quot;making Lock Settings Service ready&quot;, e);</div><div>            }</div><div>        }</div><div><br/></div><div>        // Needed by DevicePolicyManager for initialization</div><div>        mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</div><div><br/></div><div>        mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</div><div><br/></div><div>        try {</div><div>            wm.systemReady();</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making Window Manager Service ready&quot;, e);</div><div>        }</div><div><br/></div><div>        if (safeMode) {</div><div>            mActivityManagerService.showSafeModeOverlay();</div><div>        }</div><div><br/></div><div>        // Update the configuration for this context by hand, because we're going</div><div>        // to start using it before the config change done in wm.systemReady() will</div><div>        // propagate to it.</div><div>        Configuration config = wm.computeNewConfiguration();</div><div>        DisplayMetrics metrics = new DisplayMetrics();</div><div>        WindowManager w = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</div><div>        w.getDefaultDisplay().getMetrics(metrics);</div><div>        context.getResources().updateConfiguration(config, metrics);</div><div><br/></div><div>        try {</div><div>            // TODO: use boot phase</div><div>            mPowerManagerService.systemReady(mActivityManagerService.getAppOpsService());</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making Power Manager Service ready&quot;, e);</div><div>        }</div><div><br/></div><div>        try {</div><div>            mPackageManagerService.systemReady();</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making Package Manager Service ready&quot;, e);</div><div>        }</div><div><br/></div><div>        try {</div><div>            // TODO: use boot phase and communicate these flags some other way</div><div>            mDisplayManagerService.systemReady(safeMode, mOnlyCore);</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;making Display Manager Service ready&quot;, e);</div><div>        }</div><div><br/></div><div>        // These are needed to propagate to the runnable below.</div><div>        final MountService mountServiceF = mountService;</div><div>        final NetworkManagementService networkManagementF = networkManagement;</div><div>        final NetworkStatsService networkStatsF = networkStats;</div><div>        final NetworkPolicyManagerService networkPolicyF = networkPolicy;</div><div>        final ConnectivityService connectivityF = connectivity;</div><div>        final NetworkScoreService networkScoreF = networkScore;</div><div>        final WallpaperManagerService wallpaperF = wallpaper;</div><div>        final InputMethodManagerService immF = imm;</div><div>        final LocationManagerService locationF = location;</div><div>        final CountryDetectorService countryDetectorF = countryDetector;</div><div>        final NetworkTimeUpdateService networkTimeUpdaterF = networkTimeUpdater;</div><div>        final CommonTimeManagementService commonTimeMgmtServiceF = commonTimeMgmtService;</div><div>        final TextServicesManagerService textServiceManagerServiceF = tsms;</div><div>        final StatusBarManagerService statusBarF = statusBar;</div><div>        final AssetAtlasService atlasF = atlas;</div><div>        final InputManagerService inputManagerF = inputManager;</div><div>        final TelephonyRegistry telephonyRegistryF = telephonyRegistry;</div><div>        final MediaRouterService mediaRouterF = mediaRouter;</div><div>        final AudioService audioServiceF = audioService;</div><div>        final MmsServiceBroker mmsServiceF = mmsService;</div><div><br/></div><div>        /// M: add for Mobile Manager Service</div><div>        final MobileManagerService momF = mom;</div><div>        /// M: add for Recovery ManagerService</div><div>        final RecoveryManagerService recoveryF = mRecoveryManagerService;</div><div>        /// M: add for hdmi feature</div><div>        final IPerfServiceManager perfServiceF = perfServiceMgr;</div><div><br/></div><div>        // We now tell the activity manager it is okay to run third party</div><div>        // code.  It will call back into us once it has gotten to the state</div><div>        // where third party code can really run (but before it has actually</div><div>        // started launching the initial applications), for us to complete our</div><div>        // initialization.</div><div>        mActivityManagerService.systemReady(new Runnable() {</div><div>            @Override</div><div>            public void run() {</div><div>                Slog.i(TAG, &quot;Making services ready&quot;);</div><div><br/></div><div>                // M: Mobile Manager Service</div><div>                try {</div><div>                    if (momF != null) momF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making MobileManagerService ready&quot;, e);</div><div>                }</div><div><br/></div><div>                mSystemServiceManager.startBootPhase(</div><div>                        SystemService.PHASE_ACTIVITY_MANAGER_READY);</div><div><br/></div><div>                try {</div><div>                    mActivityManagerService.startObservingNativeCrashes();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;observing native crashes&quot;, e);</div><div>                }</div><div><br/></div><div>                Slog.i(TAG, &quot;WebViewFactory preparation&quot;);</div><div>                WebViewFactory.prepareWebViewInSystemServer();</div><div><br/></div><div>                try {</div><div>                    startSystemUi(context);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;starting System UI&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (mountServiceF != null) mountServiceF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Mount Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (networkScoreF != null) networkScoreF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Network Score Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (networkManagementF != null) networkManagementF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Network Managment Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (networkStatsF != null) networkStatsF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Network Stats Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (networkPolicyF != null) networkPolicyF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Network Policy Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (connectivityF != null) connectivityF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making Connectivity Service ready&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (audioServiceF != null) audioServiceF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying AudioService running&quot;, e);</div><div>                }</div><div>                Watchdog.getInstance().start();</div><div><br/></div><div>                // It is now okay to let the various system services start their</div><div>                // third party code...</div><div>                mSystemServiceManager.startBootPhase(</div><div>                        SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</div><div><br/></div><div>                try {</div><div>                    if (wallpaperF != null) wallpaperF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying WallpaperService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (immF != null) immF.systemRunning(statusBarF);</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying InputMethodService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (locationF != null) locationF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying Location Service running&quot;, e);</div><div>                }</div><div>                /// M: SystemServer-TestCases @{</div><div>                if ((false == (&quot;user&quot;.equals(Build.TYPE) || &quot;userdebug&quot;.equals(Build.TYPE)))</div><div>                    &amp;&amp; SystemProperties.get(&quot;persist.sys.anr_sys_key&quot;).equals(&quot;1&quot;)) {</div><div>                    new Handler().post(new Runnable() {</div><div>                        public void run() {</div><div>                            testSystemServerANR(context);</div><div>                        }</div><div>                    });</div><div>                }</div><div>                /// @}</div><div>                try {</div><div>                    if (countryDetectorF != null) countryDetectorF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying CountryDetectorService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (networkTimeUpdaterF != null) networkTimeUpdaterF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying NetworkTimeService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (commonTimeMgmtServiceF != null) {</div><div>                        commonTimeMgmtServiceF.systemRunning();</div><div>                    }</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying CommonTimeManagementService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (textServiceManagerServiceF != null)</div><div>                        textServiceManagerServiceF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying TextServicesManagerService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (atlasF != null) atlasF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying AssetAtlasService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    // TODO(BT) Pass parameter to input manager</div><div>                    if (inputManagerF != null) inputManagerF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying InputManagerService running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (telephonyRegistryF != null) telephonyRegistryF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying TelephonyRegistry running&quot;, e);</div><div>                }</div><div>                try {</div><div>                    if (mediaRouterF != null) mediaRouterF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying MediaRouterService running&quot;, e);</div><div>                }</div><div><br/></div><div>                try {</div><div>                    if (mmsServiceF != null) mmsServiceF.systemRunning();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;Notifying MmsService running&quot;, e);</div><div>                }</div><div><br/></div><div>                /// M: add for PerfService feature @{</div><div>                if (SystemProperties.get(&quot;ro.mtk_perfservice_support&quot;).equals(&quot;1&quot;)) {</div><div>                    // Notify PerfService manager of system ready</div><div>                    try {</div><div>                        if (perfServiceF != null) perfServiceF.systemReady();</div><div>                    } catch (Throwable e) {</div><div>                        reportWtf(&quot;making PerfServiceManager ready&quot;, e);</div><div>                    }</div><div>                }</div><div>                /// @}</div><div><br/></div><div>                /// M: Recovery Manager Service @{</div><div>                try {</div><div>                    if (recoveryF != null) recoveryF.systemReady();</div><div>                } catch (Throwable e) {</div><div>                    reportWtf(&quot;making RecoveryManagerService ready&quot;, e);</div><div>                }</div><div>                /// @}</div><div>            }</div><div>        });</div><div><br/></div><div>        /// M: RecoveryManagerService @{</div><div>        try {</div><div>            if (mRecoveryManagerService != null) {</div><div>                mRecoveryManagerService.stopBootMonitor();</div><div>            }</div><div>        } catch (Throwable e) {</div><div>            reportWtf(&quot;Failure Stop Boot Monitor&quot;, e);</div><div>        }</div><div>        /// @}</div><div>    }</div><div><br/></div><div>    /// M: SystemServer-TestCases @{</div><div>    static final ComponentName testSystemServerANR(Context context) {</div><div>        ComponentName ret = null;</div><div>        Log.i(&quot;ANR_DEBUG&quot;, &quot;=== Start BadService2 ===&quot;);</div><div>        final Intent intent = new Intent(&quot;com.android.badservicesysserver&quot;);</div><div>        intent.setPackage(&quot;com.android.badservicesysserver&quot;);</div><div>        ret = context.startService(intent);</div><div><br/></div><div>        if (ret != null)</div><div>            Log.i(&quot;ANR_DEBUG&quot;, &quot;=== result to start BadService2 === Name: &quot; + ret.toString());</div><div>        else</div><div>            Log.i(&quot;ANR_DEBUG&quot;, &quot;=== result to start BadService2 === Name: Null &quot;);</div><div><br/></div><div>        return ret;</div><div>    }</div><div>    /// @}</div><div><br/></div><div>    static final void startSystemUi(Context context) {</div><div>        Intent intent = new Intent();</div><div>        intent.setComponent(new ComponentName(&quot;com.android.systemui&quot;,</div><div>                    &quot;com.android.systemui.SystemUIService&quot;));</div><div>        //Slog.d(TAG, &quot;Starting service: &quot; + intent);</div><div>        context.startServiceAsUser(intent, UserHandle.OWNER);</div><div>    }</div><div>}</div><div><br/></div></span>
</div></body></html> 