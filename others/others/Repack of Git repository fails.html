<html>
<head>
  <title>Repack of Git repository fails</title>
  <basefont face="Microsoft YaHei" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/301769 (zh-CN); Windows/6.3.9600 (Win64);"/>
  <style>
    body, td {
      font-family: Microsoft YaHei;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1978"/>
<h1>Repack of Git repository fails</h1>

<div>
<span><br/><div><h1>Repack of Git repository fails</h1></div><div><table><tbody><tr><td><div><a target="_blank" title="This question shows research effort; it is useful and clear">up vote</a> <a target="_blank" title="This question does not show any research effort; it is unclear or not useful">down vote</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#" target="_blank" title="This is a favorite question (click again to undo)">favorite</a><div><b>28</b></div></div></td><td><div><p>I have a git repository residing on a server with limited memory. When I try to clone an existing repository from the server I get the following error</p><pre><code>hemi@ubuntu:$ git clone ssh://hemi@servername.dk/home/hemi/repos/articles
Initialized empty Git repository in /home/hemi/Skrivebord/articles/.git/
hemi@servername.dk's password: 
remote: Counting objects: 666, done.
remote: warning: suboptimal pack - out of memory
remote: fatal: Out of memory, malloc failed
error: git upload-pack: git-pack-objects died with error.
fatal: git upload-pack: aborting due to possible repository corruption on the remote side.
remote: aborting due to possible repository corruption on the remote side.
fatal: early EOF
fatal: index-pack failed
hemi@ubuntu:$ 
</code></pre><p>To handle this error I have tried to repack the original repository (according to <a href="http://git.661346.n2.nabble.com/Large-pack-causes-git-clone-failures-what-to-do-td5481488.html" target="_blank">this forum post</a>). But instead of repacking the repository it describes how to use the &quot;git pack-objects&quot; command.</p><pre><code>hemi@servername:~/repos/articles$ git repack -a -d --window-memory 10m --max-pack-size 100m
usage: git pack-objects [{ -q | --progress | --all-progress }]
        [--all-progress-implied]
        [--max-pack-size=N] [--local] [--incremental]
        [--window=N] [--window-memory=N] [--depth=N]
        [--no-reuse-delta] [--no-reuse-object] [--delta-base-offset]
        [--threads=N] [--non-empty] [--revs [--unpacked | --all]*]
        [--reflog] [--stdout | base-name] [--include-tag]
        [--keep-unreachable | --unpack-unreachable 
        [&lt;ref-list | &lt;object-list]
</code></pre><p>Git 1.6.5.7 is installed on the server.</p></div></td></tr><tr><td></td><td><div><table><tbody><tr><td></td><td><div>How creepy that the process was killed on 666 objects... – <a href="http://stackoverflow.com/users/421329/scone" target="_blank" title="308 reputation">scone</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment30985481_4826639" target="_blank">Dec 19 '13 at 19:17</a></div></td></tr></tbody></table></div><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid answering questions in comments.">add a comment</a></div></td></tr></tbody></table></div><div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a> accepted</div></td><td><div><p>Your solution has got you a working copy locally and remotely, but will cause problems again when the remote repository decides to repack itself again. Fortunately, you can set config options that will reduce the amount of memory needed for repacking in both repositories -- these essentially make the command line parameters that you added into the default options when repacking. So, you should log in to the remote, change into the repository and do:</p><pre><code><span style="color: rgb(227, 0, 0);"><b><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">git config pack.windowMemory 10m
git config pack.packSizeLimit 20m</span></b></span></code></pre><p>You may want to do the same on your local repository. (Incidentally I guess that either your repository is very large or these are machines with little memory - these values seem very low to me.)</p><p>For what it's worth, when getting malloc failures on repacking <em>very</em> large repositories in the past, I've also changed the values of <code>core.packedgitwindowsize</code>, <code>core.packedgitlimit</code>, <code>core.deltacachesize</code>, <code>pack.deltacachesize</code>, <code>pack.window</code> and <code>pack.threads</code> but it sounds as if you don't need any further options :)</p></div></td></tr><tr><td></td><td><div><table><tbody><tr><td></td><td><div>Thanks for the config options, I was not aware of them before. The repository contains a large set of pdf files. The total size of the repository (including .git directory and the tracked files) is approc 1.1 GB. So I guess it is a large repository ;-) – <a href="http://stackoverflow.com/users/185475/midtiby" target="_blank" title="4995 reputation">midtiby</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment5375909_4829883" target="_blank">Jan 30 '11 at 10:16</a></div></td></tr><tr><td></td><td><div>@MarkLongair: you saved my day Sir! I was about to run to the store and buy some RAM upgrade :D – <a href="http://stackoverflow.com/users/532495/andresch-serj" target="_blank" title="5746 reputation">Andresch Serj</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment19964995_4829883" target="_blank">Jan 16 '13 at 13:38</a></div></td></tr><tr><td></td><td><div>@MarkLongair: Great answer!!! Thanks for such a useful info – <a href="http://stackoverflow.com/users/2388940/nish" target="_blank" title="1320 reputation">nish</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment35861732_4829883" target="_blank">May 1 '14 at 9:42</a></div></td></tr></tbody></table></div><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a></div></td><td><div><p>I solved the problem using the following steps.</p><ol><li>Got repository checked out from the server to my local machine (using a raw copy over ssh)</li><li>Repacked the local repository<br/><code>git repack -a -d --window-memory 10m --max-pack-size 20m</code></li><li>Created an empty repository on the server<br/><code>git init --bare</code></li><li>Pushed the local repository to the server</li><li>Checked that it is possible to clone the server repository</li></ol></div></td></tr><tr><td></td><td><div><table><tbody><tr><td></td><td><div>I'm glad to hear you got that sorted, but I should warn you that you'll have the same problem again when the server decides to repack its repository. It would be best to set the config options in the remote repository (e.g. as suggested in my answer) so that when it does automatically repack, you still won't run out of memory. – <a href="http://stackoverflow.com/users/223092/mark-longair" target="_blank" title="144781 reputation">Mark Longair</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment8966083_4828031" target="_blank">Sep 14 '11 at 15:17</a></div></td></tr></tbody></table></div><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a></div></td><td><div><p>With no direct access to repository and hence being unable to perform a repack, performing a shallow clone and then gradually fetching while increasing depth helped for me.</p><pre><code>git clone YOUR_REPO --depth=1
git fetch --depth=10
...
git fetch --depth=100
git fetch --unshallow    //Downloads all history allowing to push from repo
</code></pre><p>Hope it can still help someone.</p></div><table><tbody><tr><td></td><td><div>answered Aug 11 '13 at 9:16</div></td></tr></tbody></table></td></tr><tr><td></td><td><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a></div></td><td><div><p>This does not answer the question, but somebody might run into it: repacking might also fail on the server when <code>pack-objects</code> is terminated by some kind of memory killer (such as the one used on Dreamhost):</p><pre><code>$ git clone project-url project-folder
Cloning into project-folder...
remote: Counting objects: 6606, done.
remote: Compressing objects: 100% (2903/2903), done.
error: pack-objects died of signal 9284.51 MiB | 2.15 MiB/s   
error: git upload-pack: git-pack-objects died with error.
fatal: git upload-pack: aborting due to possible repository corruption on the remote side.
remote: aborting due to possible repository corruption on the remote side.
fatal: early EOF
fatal: index-pack failed
</code></pre><p>On Dreamhost this appears to be caused by <code>mmap</code>. The repack code uses <code>mmap</code> to map some files’ contents into memory, and as the memory killer is not smart enough, it counts the mmapped files as used memory, killing the Git process when it tries to <code>mmap</code> a large file.</p><p>The solution is to compile a custom Git binary with <code>mmap</code> support turned off (<code>configure NO_MMAP=1</code>).</p></div><table><tbody><tr><td></td><td><div>answered Oct 5 '11 at 10:35</div></td></tr></tbody></table></td></tr><tr><td></td><td><div><table><tbody><tr><td></td><td><div>Do you know if it's possible to add the NO_MMAP=1 option to an existing git install? – <a href="http://stackoverflow.com/users/138557/max-williams" target="_blank" title="16939 reputation">Max Williams</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment9780015_7659992" target="_blank">Nov 3 '11 at 12:39</a></div></td></tr><tr><td></td><td><div>I don’t think so, it looks as a preprocessor macro that leads to different code being produced. But that’s just an opinion, I didn’t research it. – <a href="http://stackoverflow.com/users/17279/zoul" target="_blank" title="61307 reputation">zoul</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment9781097_7659992" target="_blank">Nov 3 '11 at 13:29</a></div></td></tr></tbody></table></div><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a></div></td><td><div><p>I am using git version 1.7.0.4 and it accepts this command. It is possible that git version 1.6 doesn't accept this command.</p><p>Try creating a new repository with some random commits. Then repack it with this command.</p></div></td></tr><tr><td></td><td><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><div><table><tbody><tr><td><div><a target="_blank" title="This answer is useful">up vote</a> <a target="_blank" title="This answer is not useful">down vote</a></div></td><td><div><p>I had the same problem on ubuntu 14.10 with git 2.1.0 on a private github.com repository. (Entreprise router is suspected! Works on different wifi network, except at workplace)</p><pre><code>* GnuTLS recv error (-54): Error in the pull function.
* Closing connection 2jects:  31% (183/589)   
error: RPC failed; result=56, HTTP code = 200
fatal: The remote end hung up unexpectedly
fatal: protocol error: bad pack header
</code></pre><p>My solution was, to git clone using ssh (I set up ssh keys* beforehand), like this:</p><blockquote><p>git clone <a href="https://github.com/USERNAME/REPOSITORYNAME.git" target="_blank">https://github.com/USERNAME/REPOSITORYNAME.git</a></p></blockquote><p>becomes:</p><blockquote><p>git clone git@github.com:USERNAME/REPOSITORYNAME.git</p></blockquote><p>*: (Generating an ssh key)</p><blockquote><p>ssh-keygen -t rsa -C &quot;your_email_address_registered_with_github@domain.com&quot;</p></blockquote><p>Then log into github, in settings, import ssh keys, and import it from ~/.ssh/id_rsa.pub.</p></div><table><tbody><tr><td></td><td><div>answered Apr 28 '15 at 15:03</div></td></tr></tbody></table></td></tr><tr><td></td><td><div><table><tbody><tr><td></td><td><div>I've heard of enterprise routers doing content scanning and dropping connections for HTTP, but never HTTPS - does yours decode and re-encrypt HTTPS traffic too? – <a href="http://stackoverflow.com/users/243245/rup" target="_blank" title="20930 reputation">Rup</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment48060721_29922973" target="_blank">Apr 30 '15 at 14:33</a></div></td></tr><tr><td></td><td><div>Rup: There are two routers involved before getting out to the internet. Next week, I will be checking exactly how is the setup at that particular company. I verified since, it is not failing anywhere else (any other wifi network), just at that specific company. – <a href="http://stackoverflow.com/users/3378034/arcol" target="_blank" title="81 reputation">arcol</a> <a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#comment48099110_29922973" target="_blank">May 1 '15 at 15:33</a></div></td></tr></tbody></table></div><div><a target="_blank" title="Use comments to ask for more information or suggest improvements. Avoid comments like “+1” or “thanks”.">add a comment</a></div></td></tr></tbody></table></div><h2>Your Answer</h2><div><h3>Sign up or <a href="http://stackoverflow.com/users/login?ssrc=question_page&amp;returnurl=http%3a%2f%2fstackoverflow.com%2fquestions%2f4826639%2frepack-of-git-repository-fails%23new-answer" target="_blank">log in</a></h3><div><p>Sign up using Google</p></div><div><p>Sign up using Facebook</p></div><div><p>Sign up using Email and Password</p></div></div><div><h3>Post as a guest</h3><div><table><tbody><tr><td><div>Name</div><div>Email</div></td></tr></tbody></table></div></div><div><a href="http://stackoverflow.com/questions/4826639/repack-of-git-repository-fails#" target="_blank">discard</a><p>By posting your answer, you agree to the <a href="http://stackexchange.com/legal/privacy-policy" target="_blank">privacy policy</a> and <a href="http://stackexchange.com/legal/terms-of-service" target="_blank">terms of service</a>.</p></div><h2>Not the answer you're looking for? Browse other questions tagged <a href="http://stackoverflow.com/questions/tagged/git" target="_blank" title="show questions tagged &apos;git&apos;">git</a> <a href="http://stackoverflow.com/questions/tagged/repository" target="_blank" title="show questions tagged &apos;repository&apos;">repository</a> or <a href="http://stackoverflow.com/questions/ask" target="_blank">ask your own question</a>.</h2></div><br/></span>
</div></body></html> 