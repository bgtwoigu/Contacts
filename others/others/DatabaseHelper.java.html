<html>
<head>
  <title>DatabaseHelper.java</title>
  <basefont face="Microsoft YaHei" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/301769 (zh-CN); Windows/6.3.9600 (Win64);"/>
  <style>
    body, td {
      font-family: Microsoft YaHei;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1241"/>
<h1>DatabaseHelper.java</h1>

<div>
<span><div>/*</div><div>* Copyright (C) 2014 MediaTek Inc.</div><div>* Modification based on code covered by the mentioned copyright</div><div>* and/or permission notice(s).</div><div>*/</div><div>/*</div><div> * Copyright (C) 2007 The Android Open Source Project</div><div> *</div><div> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div> * you may not use this file except in compliance with the License.</div><div> * You may obtain a copy of the License at</div><div> *</div><div> *      http://www.apache.org/licenses/LICENSE-2.0</div><div> *</div><div> * Unless required by applicable law or agreed to in writing, software</div><div> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div> * See the License for the specific language governing permissions and</div><div> * limitations under the License.</div><div> */</div><div><br/></div><div>package com.android.providers.settings;</div><div><br/></div><div>import android.content.ComponentName;</div><div>import android.content.ContentValues;</div><div>import android.content.Context;</div><div>import android.content.Intent;</div><div>import android.content.pm.ActivityInfo;</div><div>import android.content.pm.IPackageManager;</div><div>import android.content.pm.PackageManager;</div><div>import android.content.res.XmlResourceParser;</div><div>import android.database.Cursor;</div><div>import android.database.sqlite.SQLiteDatabase;</div><div>import android.database.sqlite.SQLiteOpenHelper;</div><div>import android.database.sqlite.SQLiteStatement;</div><div>import android.media.AudioManager;</div><div>import android.media.AudioService;</div><div>import android.net.ConnectivityManager;</div><div>import android.os.Build;</div><div>import android.os.Environment;</div><div>import android.os.RemoteException;</div><div>import android.os.ServiceManager;</div><div>import android.os.SystemProperties;</div><div>import android.os.UserHandle;</div><div>import android.provider.Settings;</div><div>import android.provider.Settings.Global;</div><div>import android.provider.Settings.Secure;</div><div>import android.text.TextUtils;</div><div>import android.util.Log;</div><div><br/></div><div>import com.android.ims.ImsConfig;</div><div>import com.android.internal.content.PackageHelper;</div><div>import com.android.internal.telephony.RILConstants;</div><div>import com.android.internal.telephony.cdma.CdmaSubscriptionSourceManager;</div><div>import com.android.internal.util.XmlUtils;</div><div>import com.android.internal.widget.LockPatternUtils;</div><div>import com.android.internal.widget.LockPatternView;</div><div>import com.mediatek.providers.utils.ProvidersUtils;</div><div><br/></div><div>import org.xmlpull.v1.XmlPullParser;</div><div>import org.xmlpull.v1.XmlPullParserException;</div><div><br/></div><div>import java.io.File;</div><div>import java.io.IOException;</div><div>import java.util.HashSet;</div><div>import java.util.List;</div><div><br/></div><div>/**</div><div> * Database helper class for {@link SettingsProvider}.</div><div> * Mostly just has a bit {@link #onCreate} to initialize the database.</div><div> */</div><div>public class DatabaseHelper extends SQLiteOpenHelper {</div><div>    private ProvidersUtils mUtils;</div><div><br/></div><div>    private static final String TAG = &quot;SettingsProvider&quot;;</div><div>    private static final String DATABASE_NAME = &quot;settings.db&quot;;</div><div><br/></div><div>    // Please, please please. If you update the database version, check to make sure the</div><div>    // database gets upgraded properly. At a minimum, please confirm that 'upgradeVersion'</div><div>    // is properly propagated through your change.  Not doing so will result in a loss of user</div><div>    // settings.</div><div>    private static final int DATABASE_VERSION = 118;</div><div><br/></div><div>    private Context mContext;</div><div>    private int mUserHandle;</div><div><br/></div><div>    private static final HashSet&lt;String&gt; mValidTables = new HashSet&lt;String&gt;();</div><div><br/></div><div>    private static final String TABLE_SYSTEM = &quot;system&quot;;</div><div>    private static final String TABLE_SECURE = &quot;secure&quot;;</div><div>    private static final String TABLE_GLOBAL = &quot;global&quot;;</div><div><br/></div><div>    static {</div><div>        mValidTables.add(TABLE_SYSTEM);</div><div>        mValidTables.add(TABLE_SECURE);</div><div>        mValidTables.add(TABLE_GLOBAL);</div><div>        mValidTables.add(&quot;bluetooth_devices&quot;);</div><div>        mValidTables.add(&quot;bookmarks&quot;);</div><div><br/></div><div>        // These are old.</div><div>        mValidTables.add(&quot;favorites&quot;);</div><div>        mValidTables.add(&quot;gservices&quot;);</div><div>        mValidTables.add(&quot;old_favorites&quot;);</div><div>    }</div><div><br/></div><div>    static String dbNameForUser(final int userHandle) {</div><div>        // The owner gets the unadorned db name;</div><div>        if (userHandle == UserHandle.USER_OWNER) {</div><div>            return DATABASE_NAME;</div><div>        } else {</div><div>            // Place the database in the user-specific data tree so that it's</div><div>            // cleaned up automatically when the user is deleted.</div><div>            File databaseFile = new File(</div><div>                    Environment.getUserSystemDirectory(userHandle), DATABASE_NAME);</div><div>            return databaseFile.getPath();</div><div>        }</div><div>    }</div><div><br/></div><div>    public DatabaseHelper(Context context, int userHandle) {</div><div>        super(context, dbNameForUser(userHandle), null, DATABASE_VERSION);</div><div>        mContext = context;</div><div>        mUserHandle = userHandle;</div><div>    }</div><div><br/></div><div>    public static boolean isValidTable(String name) {</div><div>        return mValidTables.contains(name);</div><div>    }</div><div><br/></div><div>    private void createSecureTable(SQLiteDatabase db) {</div><div>        db.execSQL(&quot;CREATE TABLE secure (&quot; +</div><div>                &quot;_id INTEGER PRIMARY KEY AUTOINCREMENT,&quot; +</div><div>                &quot;name TEXT UNIQUE ON CONFLICT REPLACE,&quot; +</div><div>                &quot;value TEXT&quot; +</div><div>                &quot;);&quot;);</div><div>        db.execSQL(&quot;CREATE INDEX secureIndex1 ON secure (name);&quot;);</div><div>    }</div><div><br/></div><div>    private void createGlobalTable(SQLiteDatabase db) {</div><div>        db.execSQL(&quot;CREATE TABLE global (&quot; +</div><div>                &quot;_id INTEGER PRIMARY KEY AUTOINCREMENT,&quot; +</div><div>                &quot;name TEXT UNIQUE ON CONFLICT REPLACE,&quot; +</div><div>                &quot;value TEXT&quot; +</div><div>                &quot;);&quot;);</div><div>        db.execSQL(&quot;CREATE INDEX globalIndex1 ON global (name);&quot;);</div><div>    }</div><div><br/></div><div>    @Override</div><div>    public void onCreate(SQLiteDatabase db) {</div><div>        db.execSQL(&quot;CREATE TABLE system (&quot; +</div><div>                    &quot;_id INTEGER PRIMARY KEY AUTOINCREMENT,&quot; +</div><div>                    &quot;name TEXT UNIQUE ON CONFLICT REPLACE,&quot; +</div><div>                    &quot;value TEXT&quot; +</div><div>                    &quot;);&quot;);</div><div>        db.execSQL(&quot;CREATE INDEX systemIndex1 ON system (name);&quot;);</div><div><br/></div><div>        createSecureTable(db);</div><div><br/></div><div>        // Only create the global table for the singleton 'owner' user</div><div>        if (mUserHandle == UserHandle.USER_OWNER) {</div><div>            createGlobalTable(db);</div><div>        }</div><div><br/></div><div>        db.execSQL(&quot;CREATE TABLE bluetooth_devices (&quot; +</div><div>                    &quot;_id INTEGER PRIMARY KEY,&quot; +</div><div>                    &quot;name TEXT,&quot; +</div><div>                    &quot;addr TEXT,&quot; +</div><div>                    &quot;channel INTEGER,&quot; +</div><div>                    &quot;type INTEGER&quot; +</div><div>                    &quot;);&quot;);</div><div><br/></div><div>        db.execSQL(&quot;CREATE TABLE bookmarks (&quot; +</div><div>                    &quot;_id INTEGER PRIMARY KEY,&quot; +</div><div>                    &quot;title TEXT,&quot; +</div><div>                    &quot;folder TEXT,&quot; +</div><div>                    &quot;intent TEXT,&quot; +</div><div>                    &quot;shortcut INTEGER,&quot; +</div><div>                    &quot;ordering INTEGER&quot; +</div><div>                    &quot;);&quot;);</div><div><br/></div><div>        db.execSQL(&quot;CREATE INDEX bookmarksIndex1 ON bookmarks (folder);&quot;);</div><div>        db.execSQL(&quot;CREATE INDEX bookmarksIndex2 ON bookmarks (shortcut);&quot;);</div><div><br/></div><div>        // Populate bookmarks table with initial bookmarks</div><div>        boolean onlyCore = false;</div><div>        try {</div><div>            onlyCore = IPackageManager.Stub.asInterface(ServiceManager.getService(</div><div>                    &quot;package&quot;)).isOnlyCoreApps();</div><div>        } catch (RemoteException e) {</div><div>        }</div><div>        if (!onlyCore) {</div><div>            loadBookmarks(db);</div><div>        }</div><div><br/></div><div>        // Load initial volume levels into DB</div><div>        loadVolumeLevels(db);</div><div><br/></div><div>        // Load inital settings values</div><div>        loadSettings(db);</div><div>    }</div><div><br/></div><div>    @Override</div><div>    public void onUpgrade(SQLiteDatabase db, int oldVersion, int currentVersion) {</div><div>        Log.w(TAG, &quot;Upgrading settings database from version &quot; + oldVersion + &quot; to &quot;</div><div>                + currentVersion);</div><div><br/></div><div>        int upgradeVersion = oldVersion;</div><div><br/></div><div>        // Pattern for upgrade blocks:</div><div>        //</div><div>        //    if (upgradeVersion == [the DATABASE_VERSION you set] - 1) {</div><div>        //        .. your upgrade logic..</div><div>        //        upgradeVersion = [the DATABASE_VERSION you set]</div><div>        //    }</div><div><br/></div><div>        if (upgradeVersion == 20) {</div><div>            /*</div><div>             * Version 21 is part of the volume control refresh. There is no</div><div>             * longer a UI-visible for setting notification vibrate on/off (in</div><div>             * our design), but the functionality still exists. Force the</div><div>             * notification vibrate to on.</div><div>             */</div><div>            loadVibrateSetting(db, true);</div><div><br/></div><div>            upgradeVersion = 21;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 22) {</div><div>            upgradeVersion = 22;</div><div>            // Upgrade the lock gesture storage location and format</div><div>            upgradeLockPatternLocation(db);</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 23) {</div><div>            db.execSQL(&quot;UPDATE favorites SET iconResource=0 WHERE iconType=0&quot;);</div><div>            upgradeVersion = 23;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 23) {</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;ALTER TABLE favorites ADD spanX INTEGER&quot;);</div><div>                db.execSQL(&quot;ALTER TABLE favorites ADD spanY INTEGER&quot;);</div><div>                // Shortcuts, applications, folders</div><div>                db.execSQL(&quot;UPDATE favorites SET spanX=1, spanY=1 WHERE itemType&lt;=0&quot;);</div><div>                // Photo frames, clocks</div><div>                db.execSQL(</div><div>                    &quot;UPDATE favorites SET spanX=2, spanY=2 WHERE itemType=1000 or itemType=1002&quot;);</div><div>                // Search boxes</div><div>                db.execSQL(&quot;UPDATE favorites SET spanX=4, spanY=1 WHERE itemType=1001&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 24;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 24) {</div><div>            db.beginTransaction();</div><div>            try {</div><div>                // The value of the constants for preferring wifi or preferring mobile have been</div><div>                // swapped, so reload the default.</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='network_preference'&quot;);</div><div>                db.execSQL(&quot;INSERT INTO system ('name', 'value') values ('network_preference', '&quot; +</div><div>                        ConnectivityManager.DEFAULT_NETWORK_PREFERENCE + &quot;')&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 25;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 25) {</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;ALTER TABLE favorites ADD uri TEXT&quot;);</div><div>                db.execSQL(&quot;ALTER TABLE favorites ADD displayMode INTEGER&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 26;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 26) {</div><div>            // This introduces the new secure settings table.</div><div>            db.beginTransaction();</div><div>            try {</div><div>                createSecureTable(db);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 27;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 27) {</div><div>            String[] settingsToMove = {</div><div>                    Settings.Secure.ADB_ENABLED,</div><div>                    Settings.Secure.ANDROID_ID,</div><div>                    Settings.Secure.BLUETOOTH_ON,</div><div>                    Settings.Secure.DATA_ROAMING,</div><div>                    Settings.Secure.DEVICE_PROVISIONED,</div><div>                    Settings.Secure.HTTP_PROXY,</div><div>                    Settings.Secure.INSTALL_NON_MARKET_APPS,</div><div>                    Settings.Secure.LOCATION_PROVIDERS_ALLOWED,</div><div>                    Settings.Secure.LOGGING_ID,</div><div>                    Settings.Secure.NETWORK_PREFERENCE,</div><div>                    Settings.Secure.PARENTAL_CONTROL_ENABLED,</div><div>                    Settings.Secure.PARENTAL_CONTROL_LAST_UPDATE,</div><div>                    Settings.Secure.PARENTAL_CONTROL_REDIRECT_URL,</div><div>                    Settings.Secure.SETTINGS_CLASSNAME,</div><div>                    Settings.Secure.USB_MASS_STORAGE_ENABLED,</div><div>                    Settings.Secure.USE_GOOGLE_MAIL,</div><div>                    Settings.Secure.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON,</div><div>                    Settings.Secure.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY,</div><div>                    Settings.Secure.WIFI_NUM_OPEN_NETWORKS_KEPT,</div><div>                    Settings.Secure.WIFI_ON,</div><div>                    Settings.Secure.WIFI_WATCHDOG_ACCEPTABLE_PACKET_LOSS_PERCENTAGE,</div><div>                    Settings.Secure.WIFI_WATCHDOG_AP_COUNT,</div><div>                    Settings.Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_DELAY_MS,</div><div>                    Settings.Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_ENABLED,</div><div>                    Settings.Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_TIMEOUT_MS,</div><div>                    Settings.Secure.WIFI_WATCHDOG_INITIAL_IGNORED_PING_COUNT,</div><div>                    Settings.Secure.WIFI_WATCHDOG_MAX_AP_CHECKS,</div><div>                    Settings.Secure.WIFI_WATCHDOG_ON,</div><div>                    Settings.Secure.WIFI_WATCHDOG_PING_COUNT,</div><div>                    Settings.Secure.WIFI_WATCHDOG_PING_DELAY_MS,</div><div>                    Settings.Secure.WIFI_WATCHDOG_PING_TIMEOUT_MS,</div><div>                };</div><div>            moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_SECURE, settingsToMove, false);</div><div>            upgradeVersion = 28;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 28 || upgradeVersion == 29) {</div><div>            // Note: The upgrade to 28 was flawed since it didn't delete the old</div><div>            // setting first before inserting. Combining 28 and 29 with the</div><div>            // fixed version.</div><div><br/></div><div>            // This upgrade adds the STREAM_NOTIFICATION type to the list of</div><div>            // types affected by ringer modes (silent, vibrate, etc.)</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;'&quot;);</div><div>                int newValue = (1 &lt;&lt; AudioManager.STREAM_RING)</div><div>                        | (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION)</div><div>                        | (1 &lt;&lt; AudioManager.STREAM_SYSTEM);</div><div>                db.execSQL(&quot;INSERT INTO system ('name', 'value') values ('&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;', '&quot;</div><div>                        + String.valueOf(newValue) + &quot;')&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div><br/></div><div>            upgradeVersion = 30;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 30) {</div><div>            /*</div><div>             * Upgrade 31 clears the title for all quick launch shortcuts so the</div><div>             * activities' titles will be resolved at display time. Also, the</div><div>             * folder is changed to '@quicklaunch'.</div><div>             */</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;UPDATE bookmarks SET folder = '@quicklaunch'&quot;);</div><div>                db.execSQL(&quot;UPDATE bookmarks SET title = ''&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 31;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 31) {</div><div>            /*</div><div>             * Animations are now managed in preferences, and may be</div><div>             * enabled or disabled based on product resources.</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.WINDOW_ANIMATION_SCALE + &quot;'&quot;);</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.TRANSITION_ANIMATION_SCALE + &quot;'&quot;);</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadDefaultAnimationSettings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 32;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 32) {</div><div>            // The Wi-Fi watchdog SSID list is now seeded with the value of</div><div>            // the property ro.com.android.wifi-watchlist</div><div>            String wifiWatchList = SystemProperties.get(&quot;ro.com.android.wifi-watchlist&quot;);</div><div>            if (!TextUtils.isEmpty(wifiWatchList)) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    db.execSQL(&quot;INSERT OR IGNORE INTO secure(name,value) values('&quot; +</div><div>                            Settings.Secure.WIFI_WATCHDOG_WATCH_LIST + &quot;','&quot; +</div><div>                            wifiWatchList + &quot;');&quot;);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 33;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 33) {</div><div>            // Set the default zoom controls to: tap-twice to bring up +/-</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;INSERT INTO system(name,value) values('zoom','2');&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 34;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 34) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadSecure35Settings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 35;</div><div>        }</div><div>            // due to a botched merge from donut to eclair, the initialization of ASSISTED_GPS_ENABLED</div><div>            // was accidentally done out of order here.</div><div>            // to fix this, ASSISTED_GPS_ENABLED is now initialized while upgrading from 38 to 39,</div><div>            // and we intentionally do nothing from 35 to 36 now.</div><div>        if (upgradeVersion == 35) {</div><div>            upgradeVersion = 36;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 36) {</div><div>           // This upgrade adds the STREAM_SYSTEM_ENFORCED type to the list of</div><div>            // types affected by ringer modes (silent, vibrate, etc.)</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;'&quot;);</div><div>                int newValue = (1 &lt;&lt; AudioManager.STREAM_RING)</div><div>                        | (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION)</div><div>                        | (1 &lt;&lt; AudioManager.STREAM_SYSTEM)</div><div>                        | (1 &lt;&lt; AudioManager.STREAM_SYSTEM_ENFORCED);</div><div>                db.execSQL(&quot;INSERT INTO system ('name', 'value') values ('&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;', '&quot;</div><div>                        + String.valueOf(newValue) + &quot;')&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 37;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 37) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadStringSetting(stmt, Settings.System.AIRPLANE_MODE_TOGGLEABLE_RADIOS,</div><div>                        R.string.airplane_mode_toggleable_radios);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 38;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 38) {</div><div>            db.beginTransaction();</div><div>            try {</div><div>                String value =</div><div>                        mContext.getResources().getBoolean(R.bool.assisted_gps_enabled) ? &quot;1&quot; : &quot;0&quot;;</div><div>                db.execSQL(&quot;INSERT OR IGNORE INTO secure(name,value) values('&quot; +</div><div>                        Settings.Global.ASSISTED_GPS_ENABLED + &quot;','&quot; + value + &quot;');&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div><br/></div><div>            upgradeVersion = 39;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 39) {</div><div>            upgradeAutoBrightness(db);</div><div>            upgradeVersion = 40;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 40) {</div><div>            /*</div><div>             * All animations are now turned on by default!</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.WINDOW_ANIMATION_SCALE + &quot;'&quot;);</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.TRANSITION_ANIMATION_SCALE + &quot;'&quot;);</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadDefaultAnimationSettings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 41;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 41) {</div><div>            /*</div><div>             * Initialize newly public haptic feedback setting</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.HAPTIC_FEEDBACK_ENABLED + &quot;'&quot;);</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadDefaultHapticSettings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 42;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 42) {</div><div>            /*</div><div>             * Initialize new notification pulse setting</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.System.NOTIFICATION_LIGHT_PULSE,</div><div>                        R.bool.def_notification_pulse);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 43;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 43) {</div><div>            /*</div><div>             * This upgrade stores bluetooth volume separately from voice volume</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadSetting(stmt, Settings.System.VOLUME_BLUETOOTH_SCO,</div><div>                        AudioService.getDefaultStreamVolume(AudioManager.STREAM_BLUETOOTH_SCO));</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 44;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 44) {</div><div>            /*</div><div>             * Gservices was moved into vendor/google.</div><div>             */</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS gservices&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS gservicesIndex1&quot;);</div><div>            upgradeVersion = 45;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 45) {</div><div>             /*</div><div>              * New settings for MountService</div><div>              */</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;INSERT INTO secure(name,value) values('&quot; +</div><div>                        Settings.Secure.MOUNT_PLAY_NOTIFICATION_SND + &quot;','1');&quot;);</div><div>                db.execSQL(&quot;INSERT INTO secure(name,value) values('&quot; +</div><div>                        Settings.Secure.MOUNT_UMS_AUTOSTART + &quot;','0');&quot;);</div><div>                db.execSQL(&quot;INSERT INTO secure(name,value) values('&quot; +</div><div>                        Settings.Secure.MOUNT_UMS_PROMPT + &quot;','1');&quot;);</div><div>                db.execSQL(&quot;INSERT INTO secure(name,value) values('&quot; +</div><div>                        Settings.Secure.MOUNT_UMS_NOTIFY_ENABLED + &quot;','1');&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 46;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 46) {</div><div>            /*</div><div>             * The password mode constants have changed; reset back to no</div><div>             * password.</div><div>             */</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='lockscreen.password_type';&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>           upgradeVersion = 47;</div><div>       }</div><div><br/></div><div><br/></div><div>        if (upgradeVersion == 47) {</div><div>            /*</div><div>             * The password mode constants have changed again; reset back to no</div><div>             * password.</div><div>             */</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='lockscreen.password_type';&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>           upgradeVersion = 48;</div><div>       }</div><div><br/></div><div>       if (upgradeVersion == 48) {</div><div>           /*</div><div>            * Default recognition service no longer initialized here,</div><div>            * moved to RecognitionManagerService.</div><div>            */</div><div>           upgradeVersion = 49;</div><div>       }</div><div><br/></div><div>       if (upgradeVersion == 49) {</div><div>           /*</div><div>            * New settings for new user interface noises.</div><div>            */</div><div>           db.beginTransaction();</div><div>           SQLiteStatement stmt = null;</div><div>           try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadUISoundEffectsSettings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div><br/></div><div>           upgradeVersion = 50;</div><div>       }</div><div><br/></div><div>       if (upgradeVersion == 50) {</div><div>           /*</div><div>            * Install location no longer initiated here.</div><div>            */</div><div>           upgradeVersion = 51;</div><div>       }</div><div><br/></div><div>       if (upgradeVersion == 51) {</div><div>           /* Move the lockscreen related settings to Secure, including some private ones. */</div><div>           String[] settingsToMove = {</div><div>                   Secure.LOCK_PATTERN_ENABLED,</div><div>                   Secure.LOCK_PATTERN_VISIBLE,</div><div>                   Secure.LOCK_PATTERN_TACTILE_FEEDBACK_ENABLED,</div><div>                   &quot;lockscreen.password_type&quot;,</div><div>                   &quot;lockscreen.lockoutattemptdeadline&quot;,</div><div>                   &quot;lockscreen.patterneverchosen&quot;,</div><div>                   &quot;lock_pattern_autolock&quot;,</div><div>                   &quot;lockscreen.lockedoutpermanently&quot;,</div><div>                   &quot;lockscreen.password_salt&quot;</div><div>           };</div><div>           moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_SECURE, settingsToMove, false);</div><div>           upgradeVersion = 52;</div><div>       }</div><div><br/></div><div>        if (upgradeVersion == 52) {</div><div>            // new vibration/silent mode settings</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.System.VIBRATE_IN_SILENT,</div><div>                        R.bool.def_vibrate_in_silent);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div><br/></div><div>            upgradeVersion = 53;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 53) {</div><div>            /*</div><div>             * New settings for set install location UI no longer initiated here.</div><div>             */</div><div>            upgradeVersion = 54;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 54) {</div><div>            /*</div><div>             * Update the screen timeout value if set to never</div><div>             */</div><div>            db.beginTransaction();</div><div>            try {</div><div>                upgradeScreenTimeoutFromNever(db);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div><br/></div><div>            upgradeVersion = 55;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 55) {</div><div>            /* Move the install location settings. */</div><div>            String[] settingsToMove = {</div><div>                    Global.SET_INSTALL_LOCATION,</div><div>                    Global.DEFAULT_INSTALL_LOCATION</div><div>            };</div><div>            moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_SECURE, settingsToMove, false);</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadSetting(stmt, Global.SET_INSTALL_LOCATION, 0);</div><div>                loadSetting(stmt, Global.DEFAULT_INSTALL_LOCATION,</div><div>                        PackageHelper.APP_INSTALL_AUTO);</div><div>                db.setTransactionSuccessful();</div><div>             } finally {</div><div>                 db.endTransaction();</div><div>                 if (stmt != null) stmt.close();</div><div>             }</div><div>            upgradeVersion = 56;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 56) {</div><div>            /*</div><div>             * Add Bluetooth to list of toggleable radios in airplane mode</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.AIRPLANE_MODE_TOGGLEABLE_RADIOS + &quot;'&quot;);</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadStringSetting(stmt, Settings.System.AIRPLANE_MODE_TOGGLEABLE_RADIOS,</div><div>                        R.string.airplane_mode_toggleable_radios);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 57;</div><div>        }</div><div><br/></div><div>        /************* The following are Honeycomb changes ************/</div><div><br/></div><div>        if (upgradeVersion == 57) {</div><div>            /*</div><div>             * New settings to:</div><div>             *  1. Enable injection of accessibility scripts in WebViews.</div><div>             *  2. Define the key bindings for traversing web content in WebViews.</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Secure.ACCESSIBILITY_SCRIPT_INJECTION,</div><div>                        R.bool.def_accessibility_script_injection);</div><div>                stmt.close();</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadStringSetting(stmt, Settings.Secure.ACCESSIBILITY_WEB_CONTENT_KEY_BINDINGS,</div><div>                        R.string.def_accessibility_web_content_key_bindings);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 58;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 58) {</div><div>            /* Add default for new Auto Time Zone */</div><div>            int autoTimeValue = getIntValueFromSystem(db, Settings.System.AUTO_TIME, 0);</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot; + &quot; VALUES(?,?);&quot;);</div><div>                loadSetting(stmt, Settings.System.AUTO_TIME_ZONE,</div><div>                        autoTimeValue); // Sync timezone to NITZ if auto_time was enabled</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 59;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 59) {</div><div>            // Persistence for the rotation lock feature.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.System.USER_ROTATION,</div><div>                        R.integer.def_user_rotation); // should be zero degrees</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 60;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 60) {</div><div>            // Don't do this for upgrades from Gingerbread</div><div>            // Were only required for intra-Honeycomb upgrades for testing</div><div>            // upgradeScreenTimeout(db);</div><div>            upgradeVersion = 61;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 61) {</div><div>            // Don't do this for upgrades from Gingerbread</div><div>            // Were only required for intra-Honeycomb upgrades for testing</div><div>            // upgradeScreenTimeout(db);</div><div>            upgradeVersion = 62;</div><div>        }</div><div><br/></div><div>        // Change the default for screen auto-brightness mode</div><div>        if (upgradeVersion == 62) {</div><div>            // Don't do this for upgrades from Gingerbread</div><div>            // Were only required for intra-Honeycomb upgrades for testing</div><div>            // upgradeAutoBrightness(db);</div><div>            upgradeVersion = 63;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 63) {</div><div>            // This upgrade adds the STREAM_MUSIC type to the list of</div><div>             // types affected by ringer modes (silent, vibrate, etc.)</div><div>             db.beginTransaction();</div><div>             try {</div><div>                 db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                         + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;'&quot;);</div><div>                 int newValue = (1 &lt;&lt; AudioManager.STREAM_RING)</div><div>                         | (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION)</div><div>                         | (1 &lt;&lt; AudioManager.STREAM_SYSTEM)</div><div>                         | (1 &lt;&lt; AudioManager.STREAM_SYSTEM_ENFORCED)</div><div>                         | (1 &lt;&lt; AudioManager.STREAM_MUSIC);</div><div>                 db.execSQL(&quot;INSERT INTO system ('name', 'value') values ('&quot;</div><div>                         + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;', '&quot;</div><div>                         + String.valueOf(newValue) + &quot;')&quot;);</div><div>                 db.setTransactionSuccessful();</div><div>             } finally {</div><div>                 db.endTransaction();</div><div>             }</div><div>             upgradeVersion = 64;</div><div>         }</div><div><br/></div><div>        if (upgradeVersion == 64) {</div><div>            // New setting to configure the long press timeout.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadIntegerSetting(stmt, Settings.Secure.LONG_PRESS_TIMEOUT,</div><div>                        R.integer.def_long_press_timeout_millis);</div><div>                stmt.close();</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 65;</div><div>        }</div><div><br/></div><div>        /************* The following are Ice Cream Sandwich changes ************/</div><div><br/></div><div>        if (upgradeVersion == 65) {</div><div>            /*</div><div>             * Animations are removed from Settings. Turned on by default</div><div>             */</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.WINDOW_ANIMATION_SCALE + &quot;'&quot;);</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.TRANSITION_ANIMATION_SCALE + &quot;'&quot;);</div><div>                stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadDefaultAnimationSettings(stmt);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 66;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 66) {</div><div>            // This upgrade makes sure that MODE_RINGER_STREAMS_AFFECTED is set</div><div>            // according to device voice capability</div><div>            db.beginTransaction();</div><div>            try {</div><div>                int ringerModeAffectedStreams = (1 &lt;&lt; AudioManager.STREAM_RING) |</div><div>                                                (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION) |</div><div>                                                (1 &lt;&lt; AudioManager.STREAM_SYSTEM) |</div><div>                                                (1 &lt;&lt; AudioManager.STREAM_SYSTEM_ENFORCED);</div><div>                if (!mContext.getResources().getBoolean(</div><div>                        com.android.internal.R.bool.config_voice_capable)) {</div><div>                    ringerModeAffectedStreams |= (1 &lt;&lt; AudioManager.STREAM_MUSIC);</div><div>                }</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;'&quot;);</div><div>                db.execSQL(&quot;INSERT INTO system ('name', 'value') values ('&quot;</div><div>                        + Settings.System.MODE_RINGER_STREAMS_AFFECTED + &quot;', '&quot;</div><div>                        + String.valueOf(ringerModeAffectedStreams) + &quot;')&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 67;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 67) {</div><div>            // New setting to enable touch exploration.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Secure.TOUCH_EXPLORATION_ENABLED,</div><div>                        R.bool.def_touch_exploration_enabled);</div><div>                stmt.close();</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 68;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 68) {</div><div>            // Enable all system sounds by default</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                        + Settings.System.NOTIFICATIONS_USE_RING_VOLUME + &quot;'&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 69;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 69) {</div><div>            // Add RADIO_NFC to AIRPLANE_MODE_RADIO and AIRPLANE_MODE_TOGGLEABLE_RADIOS</div><div>            String airplaneRadios = mContext.getResources().getString(</div><div>                    R.string.def_airplane_mode_radios);</div><div>            String toggleableRadios = mContext.getResources().getString(</div><div>                    R.string.airplane_mode_toggleable_radios);</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;UPDATE system SET value='&quot; + airplaneRadios + &quot;' &quot; +</div><div>                        &quot;WHERE name='&quot; + Settings.System.AIRPLANE_MODE_RADIOS + &quot;'&quot;);</div><div>                db.execSQL(&quot;UPDATE system SET value='&quot; + toggleableRadios + &quot;' &quot; +</div><div>                        &quot;WHERE name='&quot; + Settings.System.AIRPLANE_MODE_TOGGLEABLE_RADIOS + &quot;'&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 70;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 70) {</div><div>            // Update all built-in bookmarks.  Some of the package names have changed.</div><div>            loadBookmarks(db);</div><div>            upgradeVersion = 71;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 71) {</div><div>             // New setting to specify whether to speak passwords in accessibility mode.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Secure.ACCESSIBILITY_SPEAK_PASSWORD,</div><div>                        R.bool.def_accessibility_speak_password);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 72;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 72) {</div><div>            // update vibration settings</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.System.VIBRATE_IN_SILENT,</div><div>                        R.bool.def_vibrate_in_silent);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 73;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 73) {</div><div>            upgradeVibrateSettingFromNone(db);</div><div>            upgradeVersion = 74;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 74) {</div><div>            // URL from which WebView loads a JavaScript based screen-reader.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value) VALUES(?,?);&quot;);</div><div>                loadStringSetting(stmt, Settings.Secure.ACCESSIBILITY_SCREEN_READER_URL,</div><div>                        R.string.def_accessibility_screen_reader_url);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 75;</div><div>        }</div><div>        if (upgradeVersion == 75) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            Cursor c = null;</div><div>            try {</div><div>                c = db.query(TABLE_SECURE, new String[] {&quot;_id&quot;, &quot;value&quot;},</div><div>                        &quot;name='lockscreen.disabled'&quot;,</div><div>                        null, null, null, null);</div><div>                // only set default if it has not yet been set</div><div>                if (c == null || c.getCount() == 0) {</div><div>                    stmt = db.compileStatement(&quot;INSERT INTO system(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadBooleanSetting(stmt, Settings.System.LOCKSCREEN_DISABLED,</div><div>                            R.bool.def_lockscreen_disabled);</div><div>                }</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (c != null) c.close();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 76;</div><div>        }</div><div><br/></div><div>        /************* The following are Jelly Bean changes ************/</div><div><br/></div><div>        if (upgradeVersion == 76) {</div><div>            // Removed VIBRATE_IN_SILENT setting</div><div>            db.beginTransaction();</div><div>            try {</div><div>                db.execSQL(&quot;DELETE FROM system WHERE name='&quot;</div><div>                                + Settings.System.VIBRATE_IN_SILENT + &quot;'&quot;);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div><br/></div><div>            upgradeVersion = 77;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 77) {</div><div>            // Introduce &quot;vibrate when ringing&quot; setting</div><div>            loadVibrateWhenRingingSetting(db);</div><div><br/></div><div>            upgradeVersion = 78;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 78) {</div><div>            // The JavaScript based screen-reader URL changes in JellyBean.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadStringSetting(stmt, Settings.Secure.ACCESSIBILITY_SCREEN_READER_URL,</div><div>                        R.string.def_accessibility_screen_reader_url);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 79;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 79) {</div><div>            // Before touch exploration was a global setting controlled by the user</div><div>            // via the UI. However, if the enabled accessibility services do not</div><div>            // handle touch exploration mode, enabling it makes no sense. Therefore,</div><div>            // now the services request touch exploration mode and the user is</div><div>            // presented with a dialog to allow that and if she does we store that</div><div>            // in the database. As a result of this change a user that has enabled</div><div>            // accessibility, touch exploration, and some accessibility services</div><div>            // may lose touch exploration state, thus rendering the device useless</div><div>            // unless sighted help is provided, since the enabled service(s) are</div><div>            // not in the list of services to which the user granted a permission</div><div>            // to put the device in touch explore mode. Here we are allowing all</div><div>            // enabled accessibility services to toggle touch exploration provided</div><div>            // accessibility and touch exploration are enabled and no services can</div><div>            // toggle touch exploration. Note that the user has already manually</div><div>            // enabled the services and touch exploration which means the she has</div><div>            // given consent to have these services work in touch exploration mode.</div><div>            final boolean accessibilityEnabled = getIntValueFromTable(db, TABLE_SECURE,</div><div>                    Settings.Secure.ACCESSIBILITY_ENABLED, 0) == 1;</div><div>            final boolean touchExplorationEnabled = getIntValueFromTable(db, TABLE_SECURE,</div><div>                    Settings.Secure.TOUCH_EXPLORATION_ENABLED, 0) == 1;</div><div>            if (accessibilityEnabled &amp;&amp; touchExplorationEnabled) {</div><div>                String enabledServices = getStringValueFromTable(db, TABLE_SECURE,</div><div>                        Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES, &quot;&quot;);</div><div>                String touchExplorationGrantedServices = getStringValueFromTable(db, TABLE_SECURE,</div><div>                        Settings.Secure.TOUCH_EXPLORATION_GRANTED_ACCESSIBILITY_SERVICES, &quot;&quot;);</div><div>                if (TextUtils.isEmpty(touchExplorationGrantedServices)</div><div>                        &amp;&amp; !TextUtils.isEmpty(enabledServices)) {</div><div>                    SQLiteStatement stmt = null;</div><div>                    try {</div><div>                        db.beginTransaction();</div><div>                        stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO secure(name,value)&quot;</div><div>                                + &quot; VALUES(?,?);&quot;);</div><div>                        loadSetting(stmt,</div><div>                                Settings.Secure.TOUCH_EXPLORATION_GRANTED_ACCESSIBILITY_SERVICES,</div><div>                                enabledServices);</div><div>                        db.setTransactionSuccessful();</div><div>                    } finally {</div><div>                        db.endTransaction();</div><div>                        if (stmt != null) stmt.close();</div><div>                    }</div><div>                }</div><div>            }</div><div>            upgradeVersion = 80;</div><div>        }</div><div><br/></div><div>        // vvv Jelly Bean MR1 changes begin here vvv</div><div><br/></div><div>        if (upgradeVersion == 80) {</div><div>            // update screensaver settings</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ENABLED,</div><div>                        com.android.internal.R.bool.config_dreamsEnabledByDefault);</div><div>                loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ACTIVATE_ON_DOCK,</div><div>                        com.android.internal.R.bool.config_dreamsActivatedOnDockByDefault);</div><div>                loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ACTIVATE_ON_SLEEP,</div><div>                        com.android.internal.R.bool.config_dreamsActivatedOnSleepByDefault);</div><div>                loadStringSetting(stmt, Settings.Secure.SCREENSAVER_COMPONENTS,</div><div>                        com.android.internal.R.string.config_dreamsDefaultComponent);</div><div>                loadStringSetting(stmt, Settings.Secure.SCREENSAVER_DEFAULT_COMPONENT,</div><div>                        com.android.internal.R.string.config_dreamsDefaultComponent);</div><div><br/></div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 81;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 81) {</div><div>            // Add package verification setting</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Global.PACKAGE_VERIFIER_ENABLE,</div><div>                        R.bool.def_package_verifier_enable);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 82;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 82) {</div><div>            // Move to per-user settings dbs</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div><br/></div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    // Migrate now-global settings. Note that this happens before</div><div>                    // new users can be created.</div><div>                    createGlobalTable(db);</div><div>                    String[] settingsToMove = hashsetToStringArray(SettingsProvider.sSystemGlobalKeys);</div><div>                    moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_GLOBAL, settingsToMove, false);</div><div>                    settingsToMove = hashsetToStringArray(SettingsProvider.sSecureGlobalKeys);</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, false);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 83;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 83) {</div><div>            // 1. Setting whether screen magnification is enabled.</div><div>            // 2. Setting for screen magnification scale.</div><div>            // 3. Setting for screen magnification auto update.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value) VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt,</div><div>                        Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_ENABLED,</div><div>                        R.bool.def_accessibility_display_magnification_enabled);</div><div>                stmt.close();</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value) VALUES(?,?);&quot;);</div><div>                loadFractionSetting(stmt, Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_SCALE,</div><div>                        R.fraction.def_accessibility_display_magnification_scale, 1);</div><div>                stmt.close();</div><div>                stmt = db.compileStatement(&quot;INSERT INTO secure(name,value) VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt,</div><div>                        Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_AUTO_UPDATE,</div><div>                        R.bool.def_accessibility_display_magnification_auto_update);</div><div><br/></div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 84;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 84) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    // Patch up the slightly-wrong key migration from 82 -&gt; 83 for those</div><div>                    // devices that missed it, ignoring if the move is redundant</div><div>                    String[] settingsToMove = {</div><div>                            Settings.Secure.ADB_ENABLED,</div><div>                            Settings.Secure.BLUETOOTH_ON,</div><div>                            Settings.Secure.DATA_ROAMING,</div><div>                            Settings.Secure.DEVICE_PROVISIONED,</div><div>                            Settings.Secure.INSTALL_NON_MARKET_APPS,</div><div>                            Settings.Secure.USB_MASS_STORAGE_ENABLED</div><div>                    };</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 85;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 85) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    // Fix up the migration, ignoring already-migrated elements, to snap up to</div><div>                    // date with new changes to the set of global versus system/secure settings</div><div>                    String[] settingsToMove = { Settings.System.STAY_ON_WHILE_PLUGGED_IN };</div><div>                    moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_GLOBAL, settingsToMove, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 86;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 86) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] settingsToMove = {</div><div>                            Settings.Global.PACKAGE_VERIFIER_ENABLE,</div><div>                            Settings.Global.PACKAGE_VERIFIER_TIMEOUT,</div><div>                            Settings.Global.PACKAGE_VERIFIER_DEFAULT_RESPONSE</div><div>                    };</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 87;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 87) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] settingsToMove = {</div><div>                            Settings.Global.DATA_STALL_ALARM_NON_AGGRESSIVE_DELAY_IN_MS,</div><div>                            Settings.Global.DATA_STALL_ALARM_AGGRESSIVE_DELAY_IN_MS,</div><div>                            Settings.Global.GPRS_REGISTER_CHECK_PERIOD_MS</div><div>                    };</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 88;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 88) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] settingsToMove = {</div><div>                            Settings.Global.BATTERY_DISCHARGE_DURATION_THRESHOLD,</div><div>                            Settings.Global.BATTERY_DISCHARGE_THRESHOLD,</div><div>                            Settings.Global.SEND_ACTION_APP_ERROR,</div><div>                            Settings.Global.DROPBOX_AGE_SECONDS,</div><div>                            Settings.Global.DROPBOX_MAX_FILES,</div><div>                            Settings.Global.DROPBOX_QUOTA_KB,</div><div>                            Settings.Global.DROPBOX_QUOTA_PERCENT,</div><div>                            Settings.Global.DROPBOX_RESERVE_PERCENT,</div><div>                            Settings.Global.DROPBOX_TAG_PREFIX,</div><div>                            Settings.Global.ERROR_LOGCAT_PREFIX,</div><div>                            Settings.Global.SYS_FREE_STORAGE_LOG_INTERVAL,</div><div>                            Settings.Global.DISK_FREE_CHANGE_REPORTING_THRESHOLD,</div><div>                            Settings.Global.SYS_STORAGE_THRESHOLD_PERCENTAGE,</div><div>                            Settings.Global.SYS_STORAGE_THRESHOLD_MAX_BYTES,</div><div>                            Settings.Global.SYS_STORAGE_FULL_THRESHOLD_BYTES,</div><div>                            Settings.Global.SYNC_MAX_RETRY_DELAY_IN_SECONDS,</div><div>                            Settings.Global.CONNECTIVITY_CHANGE_DELAY,</div><div>                            Settings.Global.CAPTIVE_PORTAL_DETECTION_ENABLED,</div><div>                            Settings.Global.CAPTIVE_PORTAL_SERVER,</div><div>                            Settings.Global.NSD_ON,</div><div>                            Settings.Global.SET_INSTALL_LOCATION,</div><div>                            Settings.Global.DEFAULT_INSTALL_LOCATION,</div><div>                            Settings.Global.INET_CONDITION_DEBOUNCE_UP_DELAY,</div><div>                            Settings.Global.INET_CONDITION_DEBOUNCE_DOWN_DELAY,</div><div>                            Settings.Global.READ_EXTERNAL_STORAGE_ENFORCED_DEFAULT,</div><div>                            Settings.Global.HTTP_PROXY,</div><div>                            Settings.Global.GLOBAL_HTTP_PROXY_HOST,</div><div>                            Settings.Global.GLOBAL_HTTP_PROXY_PORT,</div><div>                            Settings.Global.GLOBAL_HTTP_PROXY_EXCLUSION_LIST,</div><div>                            Settings.Global.SET_GLOBAL_HTTP_PROXY,</div><div>                            Settings.Global.DEFAULT_DNS_SERVER,</div><div>                    };</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 89;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 89) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] prefixesToMove = {</div><div>                            Settings.Global.BLUETOOTH_HEADSET_PRIORITY_PREFIX,</div><div>                            Settings.Global.BLUETOOTH_A2DP_SINK_PRIORITY_PREFIX,</div><div>                            Settings.Global.BLUETOOTH_INPUT_DEVICE_PRIORITY_PREFIX,</div><div>                    };</div><div><br/></div><div>                    movePrefixedSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, prefixesToMove);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 90;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 90) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] systemToGlobal = {</div><div>                            Settings.Global.WINDOW_ANIMATION_SCALE,</div><div>                            Settings.Global.TRANSITION_ANIMATION_SCALE,</div><div>                            Settings.Global.ANIMATOR_DURATION_SCALE,</div><div>                            Settings.Global.FANCY_IME_ANIMATIONS,</div><div>                            Settings.Global.COMPATIBILITY_MODE,</div><div>                            Settings.Global.EMERGENCY_TONE,</div><div>                            Settings.Global.CALL_AUTO_RETRY,</div><div>                            Settings.Global.DEBUG_APP,</div><div>                            Settings.Global.WAIT_FOR_DEBUGGER,</div><div>                            Settings.Global.SHOW_PROCESSES,</div><div>                            Settings.Global.ALWAYS_FINISH_ACTIVITIES,</div><div>                    };</div><div>                    String[] secureToGlobal = {</div><div>                            Settings.Global.PREFERRED_NETWORK_MODE,</div><div>                            Settings.Global.CDMA_SUBSCRIPTION_MODE,</div><div>                    };</div><div><br/></div><div>                    moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_GLOBAL, systemToGlobal, true);</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, secureToGlobal, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 91;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 91) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    // Move ringer mode from system to global settings</div><div>                    String[] settingsToMove = { Settings.Global.MODE_RINGER };</div><div>                    moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_GLOBAL, settingsToMove, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 92;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 92) {</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                    // consider existing primary users to have made it through user setup</div><div>                    // if the globally-scoped device-provisioned bit is set</div><div>                    // (indicating they already made it through setup as primary)</div><div>                    int deviceProvisioned = getIntValueFromTable(db, TABLE_GLOBAL,</div><div>                            Settings.Global.DEVICE_PROVISIONED, 0);</div><div>                    loadSetting(stmt, Settings.Secure.USER_SETUP_COMPLETE,</div><div>                            deviceProvisioned);</div><div>                } else {</div><div>                    // otherwise use the default</div><div>                    loadBooleanSetting(stmt, Settings.Secure.USER_SETUP_COMPLETE,</div><div>                            R.bool.def_user_setup_complete);</div><div>                }</div><div>            } finally {</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 93;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 93) {</div><div>            // Redo this step, since somehow it didn't work the first time for some users</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    // Migrate now-global settings</div><div>                    String[] settingsToMove = hashsetToStringArray(SettingsProvider.sSystemGlobalKeys);</div><div>                    moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_GLOBAL, settingsToMove, true);</div><div>                    settingsToMove = hashsetToStringArray(SettingsProvider.sSecureGlobalKeys);</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div><br/></div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 94;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 94) {</div><div>            // Add wireless charging started sound setting</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadStringSetting(stmt, Settings.Global.WIRELESS_CHARGING_STARTED_SOUND,</div><div>                            R.string.def_wireless_charging_started_sound);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 95;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 95) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                try {</div><div>                    String[] settingsToMove = { Settings.Global.BUGREPORT_IN_POWER_MENU };</div><div>                    moveSettingsToNewTable(db, TABLE_SECURE, TABLE_GLOBAL, settingsToMove, true);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 96;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 96) {</div><div>            // NOP bump due to a reverted change that some people got on upgrade.</div><div>            upgradeVersion = 97;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 97) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadIntegerSetting(stmt, Settings.Global.LOW_BATTERY_SOUND_TIMEOUT,</div><div>                            R.integer.def_low_battery_sound_timeout);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 98;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 98) {</div><div>            // no-op; LOCK_SCREEN_SHOW_NOTIFICATIONS now handled in version 106</div><div>            upgradeVersion = 99;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 99) {</div><div>            // no-op; HEADS_UP_NOTIFICATIONS_ENABLED now handled in version 100</div><div>            upgradeVersion = 100;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 100) {</div><div>            // note: LOCK_SCREEN_SHOW_NOTIFICATIONS now handled in version 106</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadIntegerSetting(stmt, Global.HEADS_UP_NOTIFICATIONS_ENABLED,</div><div>                            R.integer.def_heads_up_enabled);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 101;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 101) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadSetting(stmt, Settings.Global.DEVICE_NAME, getDefaultDeviceName());</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 102;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 102) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                // The INSTALL_NON_MARKET_APPS setting is becoming per-user rather</div><div>                // than device-global.</div><div>                if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                    // In the owner user, the global table exists so we can migrate the</div><div>                    // entry from there to the secure table, preserving its value.</div><div>                    String[] globalToSecure = {</div><div>                            Settings.Secure.INSTALL_NON_MARKET_APPS</div><div>                    };</div><div>                    moveSettingsToNewTable(db, TABLE_GLOBAL, TABLE_SECURE, globalToSecure, true);</div><div>                } else {</div><div>                    // Secondary users' dbs don't have the global table, so institute the</div><div>                    // default.</div><div>                    stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadBooleanSetting(stmt, Settings.Secure.INSTALL_NON_MARKET_APPS,</div><div>                            R.bool.def_install_non_market_apps);</div><div>                }</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 103;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion == 103) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.Secure.WAKE_GESTURE_ENABLED,</div><div>                        R.bool.def_wake_gesture_enabled);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 104;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 105) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadBooleanSetting(stmt, Settings.Global.GUEST_USER_ENABLED,</div><div>                            R.bool.def_guest_user_enabled);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 105;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 106) {</div><div>            // LOCK_SCREEN_SHOW_NOTIFICATIONS is now per-user.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadIntegerSetting(stmt, Settings.Secure.LOCK_SCREEN_SHOW_NOTIFICATIONS,</div><div>                        R.integer.def_lock_screen_show_notifications);</div><div>                if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                    final int oldShow = getIntValueFromTable(db,</div><div>                            TABLE_GLOBAL, Settings.Secure.LOCK_SCREEN_SHOW_NOTIFICATIONS, -1);</div><div>                    if (oldShow &gt;= 0) {</div><div>                        // overwrite the default with whatever you had</div><div>                        loadSetting(stmt, Settings.Secure.LOCK_SCREEN_SHOW_NOTIFICATIONS, oldShow);</div><div>                        final SQLiteStatement deleteStmt</div><div>                                = db.compileStatement(&quot;DELETE FROM global WHERE name=?&quot;);</div><div>                        deleteStmt.bindString(1, Settings.Secure.LOCK_SCREEN_SHOW_NOTIFICATIONS);</div><div>                        deleteStmt.execute();</div><div>                    }</div><div>                }</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 106;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 107) {</div><div>            // Add trusted sound setting</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadStringSetting(stmt, Settings.Global.TRUSTED_SOUND,</div><div>                            R.string.def_trusted_sound);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 107;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 108) {</div><div>            // Reset the auto-brightness setting to default since the behavior</div><div>            // of the feature is now quite different and is being presented to</div><div>            // the user in a new way as &quot;adaptive brightness&quot;.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Settings.System.SCREEN_BRIGHTNESS_MODE,</div><div>                        R.bool.def_screen_brightness_automatic_mode);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 108;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 109) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadBooleanSetting(stmt, Secure.LOCK_SCREEN_ALLOW_PRIVATE_NOTIFICATIONS,</div><div>                        R.bool.def_lock_screen_allow_private_notifications);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 109;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 110) {</div><div>            // The SIP_CALL_OPTIONS value SIP_ASK_EACH_TIME is being deprecated.</div><div>            // If the SIP_CALL_OPTIONS setting is set to SIP_ASK_EACH_TIME, default to</div><div>            // SIP_ADDRESS_ONLY.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;UPDATE system SET value = ? &quot; +</div><div>                        &quot;WHERE name = ? AND value = ?;&quot;);</div><div>                stmt.bindString(1, Settings.System.SIP_ADDRESS_ONLY);</div><div>                stmt.bindString(2, Settings.System.SIP_CALL_OPTIONS);</div><div>                stmt.bindString(3, Settings.System.SIP_ASK_ME_EACH_TIME);</div><div>                stmt.execute();</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 110;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 111) {</div><div>            // reset ringer mode, so it doesn't force zen mode to follow</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadSetting(stmt, Settings.Global.MODE_RINGER, AudioManager.RINGER_MODE_NORMAL);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div><br/></div><div>                ///M:</div><div>                if (mUtils == null) {</div><div>                    mUtils = new ProvidersUtils(mContext);</div><div>                }</div><div>                mUtils.updateAudioProfileActiveKey(stmt, db);</div><div>            }</div><div>            upgradeVersion = 111;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 112) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                // When device name was added, we went with Manufacturer + Model, device name should</div><div>                // actually be Model only.</div><div>                // Update device name to Model if it wasn't modified by user.</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;UPDATE global SET value = ? &quot;</div><div>                        + &quot; WHERE name = ? AND value = ?&quot;);</div><div>                    stmt.bindString(1, getDefaultDeviceName()); // new default device name</div><div>                    stmt.bindString(2, Settings.Global.DEVICE_NAME);</div><div>                    stmt.bindString(3, getOldDefaultDeviceName()); // old default device name</div><div>                    stmt.execute();</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 112;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 113) {</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadIntegerSetting(stmt, Settings.Secure.SLEEP_TIMEOUT,</div><div>                        R.integer.def_sleep_timeout);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 113;</div><div>        }</div><div><br/></div><div>        // We skipped 114 to handle a merge conflict with the introduction of theater mode.</div><div><br/></div><div>        if (upgradeVersion &lt; 115) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadBooleanSetting(stmt, Global.THEATER_MODE_ON,</div><div>                            R.bool.def_theater_mode_on);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 115;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 116) {</div><div>            if (mUserHandle == UserHandle.USER_OWNER) {</div><div>                db.beginTransaction();</div><div>                SQLiteStatement stmt = null;</div><div>                try {</div><div>                    stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO global(name,value)&quot;</div><div>                            + &quot; VALUES(?,?);&quot;);</div><div>                    loadSetting(stmt, Settings.Global.ENHANCED_4G_MODE_ENABLED, ImsConfig.FeatureValueConstants.ON);</div><div>                    db.setTransactionSuccessful();</div><div>                } finally {</div><div>                    db.endTransaction();</div><div>                    if (stmt != null) stmt.close();</div><div>                }</div><div>            }</div><div>            upgradeVersion = 116;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 117) {</div><div>            db.beginTransaction();</div><div>            try {</div><div>                String[] systemToSecure = {</div><div>                        Settings.Secure.LOCK_TO_APP_EXIT_LOCKED</div><div>                };</div><div>                moveSettingsToNewTable(db, TABLE_SYSTEM, TABLE_SECURE, systemToSecure, true);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>            }</div><div>            upgradeVersion = 117;</div><div>        }</div><div><br/></div><div>        if (upgradeVersion &lt; 118) {</div><div>            // Reset rotation-lock-for-accessibility on upgrade, since it now hides the display</div><div>            // setting.</div><div>            db.beginTransaction();</div><div>            SQLiteStatement stmt = null;</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div>                loadSetting(stmt, Settings.System.HIDE_ROTATION_LOCK_TOGGLE_FOR_ACCESSIBILITY, 0);</div><div>                db.setTransactionSuccessful();</div><div>            } finally {</div><div>                db.endTransaction();</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>            upgradeVersion = 118;</div><div>        }</div><div>        // *** Remember to update DATABASE_VERSION above!</div><div><br/></div><div>        if (upgradeVersion != currentVersion) {</div><div>            Log.w(TAG, &quot;Got stuck trying to upgrade from version &quot; + upgradeVersion</div><div>                    + &quot;, must wipe the settings provider&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS global&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS globalIndex1&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS system&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS systemIndex1&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS secure&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS secureIndex1&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS gservices&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS gservicesIndex1&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS bluetooth_devices&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS bookmarks&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS bookmarksIndex1&quot;);</div><div>            db.execSQL(&quot;DROP INDEX IF EXISTS bookmarksIndex2&quot;);</div><div>            db.execSQL(&quot;DROP TABLE IF EXISTS favorites&quot;);</div><div>            onCreate(db);</div><div><br/></div><div>            // Added for diagnosing settings.db wipes after the fact</div><div>            String wipeReason = oldVersion + &quot;/&quot; + upgradeVersion + &quot;/&quot; + currentVersion;</div><div>            db.execSQL(&quot;INSERT INTO secure(name,value) values('&quot; +</div><div>                    &quot;wiped_db_reason&quot; + &quot;','&quot; + wipeReason + &quot;');&quot;);</div><div>        }</div><div>    }</div><div><br/></div><div>    private String[] hashsetToStringArray(HashSet&lt;String&gt; set) {</div><div>        String[] array = new String[set.size()];</div><div>        return set.toArray(array);</div><div>    }</div><div><br/></div><div>    private void moveSettingsToNewTable(SQLiteDatabase db,</div><div>            String sourceTable, String destTable,</div><div>            String[] settingsToMove, boolean doIgnore) {</div><div>        // Copy settings values from the source table to the dest, and remove from the source</div><div>        SQLiteStatement insertStmt = null;</div><div>        SQLiteStatement deleteStmt = null;</div><div><br/></div><div>        db.beginTransaction();</div><div>        try {</div><div>            insertStmt = db.compileStatement(&quot;INSERT &quot;</div><div>                    + (doIgnore ? &quot; OR IGNORE &quot; : &quot;&quot;)</div><div>                    + &quot; INTO &quot; + destTable + &quot; (name,value) SELECT name,value FROM &quot;</div><div>                    + sourceTable + &quot; WHERE name=?&quot;);</div><div>            deleteStmt = db.compileStatement(&quot;DELETE FROM &quot; + sourceTable + &quot; WHERE name=?&quot;);</div><div><br/></div><div>            for (String setting : settingsToMove) {</div><div>                insertStmt.bindString(1, setting);</div><div>                insertStmt.execute();</div><div><br/></div><div>                deleteStmt.bindString(1, setting);</div><div>                deleteStmt.execute();</div><div>            }</div><div>            db.setTransactionSuccessful();</div><div>        } finally {</div><div>            db.endTransaction();</div><div>            if (insertStmt != null) {</div><div>                insertStmt.close();</div><div>            }</div><div>            if (deleteStmt != null) {</div><div>                deleteStmt.close();</div><div>            }</div><div>        }</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Move any settings with the given prefixes from the source table to the</div><div>     * destination table.</div><div>     */</div><div>    private void movePrefixedSettingsToNewTable(</div><div>            SQLiteDatabase db, String sourceTable, String destTable, String[] prefixesToMove) {</div><div>        SQLiteStatement insertStmt = null;</div><div>        SQLiteStatement deleteStmt = null;</div><div><br/></div><div>        db.beginTransaction();</div><div>        try {</div><div>            insertStmt = db.compileStatement(&quot;INSERT INTO &quot; + destTable</div><div>                    + &quot; (name,value) SELECT name,value FROM &quot; + sourceTable</div><div>                    + &quot; WHERE substr(name,0,?)=?&quot;);</div><div>            deleteStmt = db.compileStatement(</div><div>                    &quot;DELETE FROM &quot; + sourceTable + &quot; WHERE substr(name,0,?)=?&quot;);</div><div><br/></div><div>            for (String prefix : prefixesToMove) {</div><div>                insertStmt.bindLong(1, prefix.length() + 1);</div><div>                insertStmt.bindString(2, prefix);</div><div>                insertStmt.execute();</div><div><br/></div><div>                deleteStmt.bindLong(1, prefix.length() + 1);</div><div>                deleteStmt.bindString(2, prefix);</div><div>                deleteStmt.execute();</div><div>            }</div><div>            db.setTransactionSuccessful();</div><div>        } finally {</div><div>            db.endTransaction();</div><div>            if (insertStmt != null) {</div><div>                insertStmt.close();</div><div>            }</div><div>            if (deleteStmt != null) {</div><div>                deleteStmt.close();</div><div>            }</div><div>        }</div><div>    }</div><div><br/></div><div>    private void upgradeLockPatternLocation(SQLiteDatabase db) {</div><div>        Cursor c = db.query(TABLE_SYSTEM, new String[] {&quot;_id&quot;, &quot;value&quot;}, &quot;name='lock_pattern'&quot;,</div><div>                null, null, null, null);</div><div>        if (c.getCount() &gt; 0) {</div><div>            c.moveToFirst();</div><div>            String lockPattern = c.getString(1);</div><div>            if (!TextUtils.isEmpty(lockPattern)) {</div><div>                // Convert lock pattern</div><div>                try {</div><div>                    LockPatternUtils lpu = new LockPatternUtils(mContext);</div><div>                    List&lt;LockPatternView.Cell&gt; cellPattern =</div><div>                            LockPatternUtils.stringToPattern(lockPattern);</div><div>                    lpu.saveLockPattern(cellPattern);</div><div>                } catch (IllegalArgumentException e) {</div><div>                    // Don't want corrupted lock pattern to hang the reboot process</div><div>                }</div><div>            }</div><div>            c.close();</div><div>            db.delete(TABLE_SYSTEM, &quot;name='lock_pattern'&quot;, null);</div><div>        } else {</div><div>            c.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void upgradeScreenTimeoutFromNever(SQLiteDatabase db) {</div><div>        // See if the timeout is -1 (for &quot;Never&quot;).</div><div>        Cursor c = db.query(TABLE_SYSTEM, new String[] { &quot;_id&quot;, &quot;value&quot; }, &quot;name=? AND value=?&quot;,</div><div>                new String[] { Settings.System.SCREEN_OFF_TIMEOUT, &quot;-1&quot; },</div><div>                null, null, null);</div><div><br/></div><div>        SQLiteStatement stmt = null;</div><div>        if (c.getCount() &gt; 0) {</div><div>            c.close();</div><div>            try {</div><div>                stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                        + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>                // Set the timeout to 30 minutes in milliseconds</div><div>                loadSetting(stmt, Settings.System.SCREEN_OFF_TIMEOUT,</div><div>                        Integer.toString(30 * 60 * 1000));</div><div>            } finally {</div><div>                if (stmt != null) stmt.close();</div><div>            }</div><div>        } else {</div><div>            c.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void upgradeVibrateSettingFromNone(SQLiteDatabase db) {</div><div>        int vibrateSetting = getIntValueFromSystem(db, Settings.System.VIBRATE_ON, 0);</div><div>        // If the ringer vibrate value is invalid, set it to the default</div><div>        if ((vibrateSetting &amp; 3) == AudioManager.VIBRATE_SETTING_OFF) {</div><div>            vibrateSetting = AudioService.getValueForVibrateSetting(0,</div><div>                    AudioManager.VIBRATE_TYPE_RINGER, AudioManager.VIBRATE_SETTING_ONLY_SILENT);</div><div>        }</div><div>        // Apply the same setting to the notification vibrate value</div><div>        vibrateSetting = AudioService.getValueForVibrateSetting(vibrateSetting,</div><div>                AudioManager.VIBRATE_TYPE_NOTIFICATION, vibrateSetting);</div><div><br/></div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div>            loadSetting(stmt, Settings.System.VIBRATE_ON, vibrateSetting);</div><div>        } finally {</div><div>            if (stmt != null)</div><div>                stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void upgradeScreenTimeout(SQLiteDatabase db) {</div><div>        // Change screen timeout to current default</div><div>        db.beginTransaction();</div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR REPLACE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div>            loadIntegerSetting(stmt, Settings.System.SCREEN_OFF_TIMEOUT,</div><div>                    R.integer.def_screen_off_timeout);</div><div>            db.setTransactionSuccessful();</div><div>        } finally {</div><div>            db.endTransaction();</div><div>            if (stmt != null)</div><div>                stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void upgradeAutoBrightness(SQLiteDatabase db) {</div><div>        db.beginTransaction();</div><div>        try {</div><div>            String value =</div><div>                    mContext.getResources().getBoolean(</div><div>                    R.bool.def_screen_brightness_automatic_mode) ? &quot;1&quot; : &quot;0&quot;;</div><div>            db.execSQL(&quot;INSERT OR REPLACE INTO system(name,value) values('&quot; +</div><div>                    Settings.System.SCREEN_BRIGHTNESS_MODE + &quot;','&quot; + value + &quot;');&quot;);</div><div>            db.setTransactionSuccessful();</div><div>        } finally {</div><div>            db.endTransaction();</div><div>        }</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Loads the default set of bookmarked shortcuts from an xml file.</div><div>     *</div><div>     * @param db The database to write the values into</div><div>     */</div><div>    private void loadBookmarks(SQLiteDatabase db) {</div><div>        ContentValues values = new ContentValues();</div><div><br/></div><div>        PackageManager packageManager = mContext.getPackageManager();</div><div>        try {</div><div>            XmlResourceParser parser = mContext.getResources().getXml(R.xml.bookmarks);</div><div>            XmlUtils.beginDocument(parser, &quot;bookmarks&quot;);</div><div><br/></div><div>            final int depth = parser.getDepth();</div><div>            int type;</div><div><br/></div><div>            while (((type = parser.next()) != XmlPullParser.END_TAG ||</div><div>                    parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) {</div><div><br/></div><div>                if (type != XmlPullParser.START_TAG) {</div><div>                    continue;</div><div>                }</div><div><br/></div><div>                String name = parser.getName();</div><div>                if (!&quot;bookmark&quot;.equals(name)) {</div><div>                    break;</div><div>                }</div><div><br/></div><div>                String pkg = parser.getAttributeValue(null, &quot;package&quot;);</div><div>                String cls = parser.getAttributeValue(null, &quot;class&quot;);</div><div>                String shortcutStr = parser.getAttributeValue(null, &quot;shortcut&quot;);</div><div>                String category = parser.getAttributeValue(null, &quot;category&quot;);</div><div><br/></div><div>                int shortcutValue = shortcutStr.charAt(0);</div><div>                if (TextUtils.isEmpty(shortcutStr)) {</div><div>                    Log.w(TAG, &quot;Unable to get shortcut for: &quot; + pkg + &quot;/&quot; + cls);</div><div>                    continue;</div><div>                }</div><div><br/></div><div>                final Intent intent;</div><div>                final String title;</div><div>                if (pkg != null &amp;&amp; cls != null) {</div><div>                    ActivityInfo info = null;</div><div>                    ComponentName cn = new ComponentName(pkg, cls);</div><div>                    try {</div><div>                        info = packageManager.getActivityInfo(cn, 0);</div><div>                    } catch (PackageManager.NameNotFoundException e) {</div><div>                        String[] packages = packageManager.canonicalToCurrentPackageNames(</div><div>                                new String[] { pkg });</div><div>                        cn = new ComponentName(packages[0], cls);</div><div>                        try {</div><div>                            info = packageManager.getActivityInfo(cn, 0);</div><div>                        } catch (PackageManager.NameNotFoundException e1) {</div><div>                            Log.w(TAG, &quot;Unable to add bookmark: &quot; + pkg + &quot;/&quot; + cls, e);</div><div>                            continue;</div><div>                        }</div><div>                    }</div><div><br/></div><div>                    intent = new Intent(Intent.ACTION_MAIN, null);</div><div>                    intent.addCategory(Intent.CATEGORY_LAUNCHER);</div><div>                    intent.setComponent(cn);</div><div>                    title = info.loadLabel(packageManager).toString();</div><div>                } else if (category != null) {</div><div>                    intent = Intent.makeMainSelectorActivity(Intent.ACTION_MAIN, category);</div><div>                    title = &quot;&quot;;</div><div>                } else {</div><div>                    Log.w(TAG, &quot;Unable to add bookmark for shortcut &quot; + shortcutStr</div><div>                            + &quot;: missing package/class or category attributes&quot;);</div><div>                    continue;</div><div>                }</div><div><br/></div><div>                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div>                values.put(Settings.Bookmarks.INTENT, intent.toUri(0));</div><div>                values.put(Settings.Bookmarks.TITLE, title);</div><div>                values.put(Settings.Bookmarks.SHORTCUT, shortcutValue);</div><div>                db.delete(&quot;bookmarks&quot;, &quot;shortcut = ?&quot;,</div><div>                        new String[] { Integer.toString(shortcutValue) });</div><div>                db.insert(&quot;bookmarks&quot;, null, values);</div><div>            }</div><div>        } catch (XmlPullParserException e) {</div><div>            Log.w(TAG, &quot;Got execption parsing bookmarks.&quot;, e);</div><div>        } catch (IOException e) {</div><div>            Log.w(TAG, &quot;Got execption parsing bookmarks.&quot;, e);</div><div>        }</div><div>    }</div><div><br/></div><div>    /**</div><div>     * Loads the default volume levels. It is actually inserting the index of</div><div>     * the volume array for each of the volume controls.</div><div>     *</div><div>     * @param db the database to insert the volume levels into</div><div>     */</div><div>    private void loadVolumeLevels(SQLiteDatabase db) {</div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>            loadSetting(stmt, Settings.System.VOLUME_MUSIC,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_MUSIC));</div><div>            loadSetting(stmt, Settings.System.VOLUME_RING,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_RING));</div><div>            loadSetting(stmt, Settings.System.VOLUME_SYSTEM,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_SYSTEM));</div><div>            loadSetting(</div><div>                    stmt,</div><div>                    Settings.System.VOLUME_VOICE,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_VOICE_CALL));</div><div>            loadSetting(stmt, Settings.System.VOLUME_ALARM,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_ALARM));</div><div>            loadSetting(</div><div>                    stmt,</div><div>                    Settings.System.VOLUME_NOTIFICATION,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_NOTIFICATION));</div><div>            loadSetting(</div><div>                    stmt,</div><div>                    Settings.System.VOLUME_BLUETOOTH_SCO,</div><div>                    AudioService.getDefaultStreamVolume(AudioManager.STREAM_BLUETOOTH_SCO));</div><div><br/></div><div>            // By default:</div><div>            // - ringtones, notification, system and music streams are affected by ringer mode</div><div>            // on non voice capable devices (tablets)</div><div>            // - ringtones, notification and system streams are affected by ringer mode</div><div>            // on voice capable devices (phones)</div><div>            int ringerModeAffectedStreams = (1 &lt;&lt; AudioManager.STREAM_RING) |</div><div>                                            (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION) |</div><div>                                            (1 &lt;&lt; AudioManager.STREAM_SYSTEM) |</div><div>                                            (1 &lt;&lt; AudioManager.STREAM_SYSTEM_ENFORCED);</div><div>            if (!mContext.getResources().getBoolean(</div><div>                    com.android.internal.R.bool.config_voice_capable)) {</div><div>                ringerModeAffectedStreams |= (1 &lt;&lt; AudioManager.STREAM_MUSIC);</div><div>            }</div><div>            loadSetting(stmt, Settings.System.MODE_RINGER_STREAMS_AFFECTED,</div><div>                    ringerModeAffectedStreams);</div><div><br/></div><div>            loadSetting(stmt, Settings.System.MUTE_STREAMS_AFFECTED,</div><div>                    ((1 &lt;&lt; AudioManager.STREAM_MUSIC) |</div><div>                     (1 &lt;&lt; AudioManager.STREAM_RING) |</div><div>                     (1 &lt;&lt; AudioManager.STREAM_NOTIFICATION) |</div><div>                     (1 &lt;&lt; AudioManager.STREAM_SYSTEM)));</div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div><br/></div><div>        loadVibrateWhenRingingSetting(db);</div><div>    }</div><div><br/></div><div>    private void loadVibrateSetting(SQLiteDatabase db, boolean deleteOld) {</div><div>        if (deleteOld) {</div><div>            db.execSQL(&quot;DELETE FROM system WHERE name='&quot; + Settings.System.VIBRATE_ON + &quot;'&quot;);</div><div>        }</div><div><br/></div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>            // Vibrate on by default for ringer, on for notification</div><div>            int vibrate = 0;</div><div>            /// M: { VIBRATE_SETTING_OFF is changed by mtk , default is VIBRATE_SETTING_ONLY_SILENT</div><div>            vibrate = AudioService.getValueForVibrateSetting(vibrate,</div><div>                    AudioManager.VIBRATE_TYPE_NOTIFICATION,</div><div>                    AudioManager.VIBRATE_SETTING_OFF);</div><div>            vibrate |= AudioService.getValueForVibrateSetting(vibrate,</div><div>                    AudioManager.VIBRATE_TYPE_RINGER, AudioManager.VIBRATE_SETTING_OFF);</div><div>            loadSetting(stmt, Settings.System.VIBRATE_ON, vibrate);</div><div>            /// @}</div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadVibrateWhenRingingSetting(SQLiteDatabase db) {</div><div>        // The default should be off. VIBRATE_SETTING_ONLY_SILENT should also be ignored here.</div><div>        // Phone app should separately check whether AudioManager#getRingerMode() returns</div><div>        // RINGER_MODE_VIBRATE, with which the device should vibrate anyway.</div><div>        int vibrateSetting = getIntValueFromSystem(db, Settings.System.VIBRATE_ON,</div><div>                AudioManager.VIBRATE_SETTING_OFF);</div><div>        boolean vibrateWhenRinging = ((vibrateSetting &amp; 3) == AudioManager.VIBRATE_SETTING_ON);</div><div><br/></div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div>            loadSetting(stmt, Settings.System.VIBRATE_WHEN_RINGING, vibrateWhenRinging ? 1 : 0);</div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadSettings(SQLiteDatabase db) {</div><div><br/></div><div>        mUtils = new ProvidersUtils(mContext);</div><div><br/></div><div>        loadSystemSettings(db);</div><div>        loadSecureSettings(db);</div><div>        // The global table only exists for the 'owner' user</div><div>        if (mUserHandle == UserHandle.USER_OWNER) {</div><div>            loadGlobalSettings(db);</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadSystemSettings(SQLiteDatabase db) {</div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO system(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.System.DIM_SCREEN,</div><div>                    R.bool.def_dim_screen);</div><div>            loadIntegerSetting(stmt, Settings.System.SCREEN_OFF_TIMEOUT,</div><div>                    R.integer.def_screen_off_timeout);</div><div><br/></div><div>            // Set default cdma DTMF type</div><div>            loadSetting(stmt, Settings.System.DTMF_TONE_TYPE_WHEN_DIALING, 0);</div><div><br/></div><div>            // Set default hearing aid</div><div>            loadSetting(stmt, Settings.System.HEARING_AID, 0);</div><div><br/></div><div>            // Set default tty mode</div><div>            loadSetting(stmt, Settings.System.TTY_MODE, 0);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.System.SCREEN_BRIGHTNESS,</div><div>                    R.integer.def_screen_brightness);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.System.SCREEN_BRIGHTNESS_MODE,</div><div>                    R.bool.def_screen_brightness_automatic_mode);</div><div><br/></div><div>            loadDefaultAnimationSettings(stmt);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.System.ACCELEROMETER_ROTATION,</div><div>                    R.bool.def_accelerometer_rotation);</div><div><br/></div><div>            loadDefaultHapticSettings(stmt);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.System.NOTIFICATION_LIGHT_PULSE,</div><div>                    R.bool.def_notification_pulse);</div><div><br/></div><div>            loadUISoundEffectsSettings(stmt);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.System.POINTER_SPEED,</div><div>                    R.integer.def_pointer_speed);</div><div><br/></div><div>            ///M: load MTK new add System providers.</div><div>            mUtils.loadCustomSystemSettings(stmt);</div><div><br/></div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadUISoundEffectsSettings(SQLiteStatement stmt) {</div><div>        loadBooleanSetting(stmt, Settings.System.DTMF_TONE_WHEN_DIALING,</div><div>                R.bool.def_dtmf_tones_enabled);</div><div>        loadBooleanSetting(stmt, Settings.System.SOUND_EFFECTS_ENABLED,</div><div>                R.bool.def_sound_effects_enabled);</div><div><br/></div><div>        loadSetting(stmt, Settings.System.HAPTIC_FEEDBACK_ENABLED,</div><div>            mUtils.getBooleanValue(Settings.System.HAPTIC_FEEDBACK_ENABLED, R.bool.def_haptic_feedback));</div><div><br/></div><div>        loadIntegerSetting(stmt, Settings.System.LOCKSCREEN_SOUNDS_ENABLED,</div><div>            R.integer.def_lockscreen_sounds_enabled);</div><div>    }</div><div><br/></div><div>    private void loadDefaultAnimationSettings(SQLiteStatement stmt) {</div><div>        loadFractionSetting(stmt, Settings.System.WINDOW_ANIMATION_SCALE,</div><div>                R.fraction.def_window_animation_scale, 1);</div><div>        loadFractionSetting(stmt, Settings.System.TRANSITION_ANIMATION_SCALE,</div><div>                R.fraction.def_window_transition_scale, 1);</div><div>    }</div><div><br/></div><div>    private void loadDefaultHapticSettings(SQLiteStatement stmt) {</div><div>        loadSetting(stmt, Settings.System.HAPTIC_FEEDBACK_ENABLED,</div><div>                mUtils.getBooleanValue(Settings.System.HAPTIC_FEEDBACK_ENABLED, R.bool.def_haptic_feedback));</div><div>    }</div><div><br/></div><div>    private void loadSecureSettings(SQLiteDatabase db) {</div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO secure(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>            loadSetting(stmt, Settings.Secure.LOCATION_PROVIDERS_ALLOWED,</div><div>                mUtils.getStringValue(Settings.Secure.LOCATION_PROVIDERS_ALLOWED, R.string.def_location_providers_allowed));</div><div><br/></div><div>            String wifiWatchList = SystemProperties.get(&quot;ro.com.android.wifi-watchlist&quot;);</div><div>            if (!TextUtils.isEmpty(wifiWatchList)) {</div><div>                loadSetting(stmt, Settings.Secure.WIFI_WATCHDOG_WATCH_LIST, wifiWatchList);</div><div>            }</div><div><br/></div><div>            // Don't do this.  The SystemServer will initialize ADB_ENABLED from a</div><div>            // persistent system property instead.</div><div>            //loadSetting(stmt, Settings.Secure.ADB_ENABLED, 0);</div><div><br/></div><div>            // Allow mock locations default, based on build</div><div>            loadSetting(stmt, Settings.Secure.ALLOW_MOCK_LOCATION,</div><div>                    &quot;1&quot;.equals(SystemProperties.get(&quot;ro.allow.mock.location&quot;)) ? 1 : 0);</div><div><br/></div><div>            loadSecure35Settings(stmt);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.MOUNT_PLAY_NOTIFICATION_SND,</div><div>                    R.bool.def_mount_play_notification_snd);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.MOUNT_UMS_AUTOSTART,</div><div>                    R.bool.def_mount_ums_autostart);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.MOUNT_UMS_PROMPT,</div><div>                    R.bool.def_mount_ums_prompt);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.MOUNT_UMS_NOTIFY_ENABLED,</div><div>                    R.bool.def_mount_ums_notify_enabled);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.ACCESSIBILITY_SCRIPT_INJECTION,</div><div>                    R.bool.def_accessibility_script_injection);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Secure.ACCESSIBILITY_WEB_CONTENT_KEY_BINDINGS,</div><div>                    R.string.def_accessibility_web_content_key_bindings);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Secure.LONG_PRESS_TIMEOUT,</div><div>                    R.integer.def_long_press_timeout_millis);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.TOUCH_EXPLORATION_ENABLED,</div><div>                    R.bool.def_touch_exploration_enabled);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.ACCESSIBILITY_SPEAK_PASSWORD,</div><div>                    R.bool.def_accessibility_speak_password);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Secure.ACCESSIBILITY_SCREEN_READER_URL,</div><div>                    R.string.def_accessibility_screen_reader_url);</div><div><br/></div><div>            if (SystemProperties.getBoolean(&quot;ro.lockscreen.disable.default&quot;, false) == true) {</div><div>                loadSetting(stmt, Settings.System.LOCKSCREEN_DISABLED, &quot;1&quot;);</div><div>            } else {</div><div>                loadBooleanSetting(stmt, Settings.System.LOCKSCREEN_DISABLED,</div><div>                        R.bool.def_lockscreen_disabled);</div><div>            }</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ENABLED,</div><div>                    com.android.internal.R.bool.config_dreamsEnabledByDefault);</div><div>            loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ACTIVATE_ON_DOCK,</div><div>                    com.android.internal.R.bool.config_dreamsActivatedOnDockByDefault);</div><div>            loadBooleanSetting(stmt, Settings.Secure.SCREENSAVER_ACTIVATE_ON_SLEEP,</div><div>                    com.android.internal.R.bool.config_dreamsActivatedOnSleepByDefault);</div><div>            loadStringSetting(stmt, Settings.Secure.SCREENSAVER_COMPONENTS,</div><div>                    com.android.internal.R.string.config_dreamsDefaultComponent);</div><div>            loadStringSetting(stmt, Settings.Secure.SCREENSAVER_DEFAULT_COMPONENT,</div><div>                    com.android.internal.R.string.config_dreamsDefaultComponent);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_ENABLED,</div><div>                    R.bool.def_accessibility_display_magnification_enabled);</div><div><br/></div><div>            loadFractionSetting(stmt, Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_SCALE,</div><div>                    R.fraction.def_accessibility_display_magnification_scale, 1);</div><div><br/></div><div>            loadBooleanSetting(stmt,</div><div>                    Settings.Secure.ACCESSIBILITY_DISPLAY_MAGNIFICATION_AUTO_UPDATE,</div><div>                    R.bool.def_accessibility_display_magnification_auto_update);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.USER_SETUP_COMPLETE,</div><div>                    R.bool.def_user_setup_complete);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Secure.IMMERSIVE_MODE_CONFIRMATIONS,</div><div>                        R.string.def_immersive_mode_confirmations);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.INSTALL_NON_MARKET_APPS,</div><div>                    R.bool.def_install_non_market_apps);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Secure.WAKE_GESTURE_ENABLED,</div><div>                    R.bool.def_wake_gesture_enabled);</div><div><br/></div><div>            loadIntegerSetting(stmt, Secure.LOCK_SCREEN_SHOW_NOTIFICATIONS,</div><div>                    R.integer.def_lock_screen_show_notifications);</div><div><br/></div><div>            loadBooleanSetting(stmt, Secure.LOCK_SCREEN_ALLOW_PRIVATE_NOTIFICATIONS,</div><div>                    R.bool.def_lock_screen_allow_private_notifications);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Secure.SLEEP_TIMEOUT,</div><div>                    R.integer.def_sleep_timeout);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Secure.DEFAULT_INPUT_METHOD,</div><div>                    R.string.config_default_input_method);       // add 2015-12</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Secure.DEFAULT_INPUT_METHOD,</div><div>                    R.string.def_enabled_input_methods);          // add 2015-12</div><div><br/></div><div>            mUtils.loadCustomSecureSettings(stmt);</div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadSecure35Settings(SQLiteStatement stmt) {</div><div>        loadBooleanSetting(stmt, Settings.Secure.BACKUP_ENABLED,</div><div>                R.bool.def_backup_enabled);</div><div><br/></div><div>        loadStringSetting(stmt, Settings.Secure.BACKUP_TRANSPORT,</div><div>                R.string.def_backup_transport);</div><div>    }</div><div><br/></div><div>    private void loadGlobalSettings(SQLiteDatabase db) {</div><div>        SQLiteStatement stmt = null;</div><div>        try {</div><div>            stmt = db.compileStatement(&quot;INSERT OR IGNORE INTO global(name,value)&quot;</div><div>                    + &quot; VALUES(?,?);&quot;);</div><div><br/></div><div>            // --- Previously in 'system'</div><div>            loadBooleanSetting(stmt, Settings.Global.AIRPLANE_MODE_ON,</div><div>                    R.bool.def_airplane_mode_on);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.THEATER_MODE_ON,</div><div>                    R.bool.def_theater_mode_on);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Global.AIRPLANE_MODE_RADIOS,</div><div>                    R.string.def_airplane_mode_radios);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Global.AIRPLANE_MODE_TOGGLEABLE_RADIOS,</div><div>                    R.string.airplane_mode_toggleable_radios);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.ASSISTED_GPS_ENABLED,</div><div>                    R.bool.assisted_gps_enabled);</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.AUTO_TIME,</div><div>                    mUtils.getBooleanValue(Settings.Global.AUTO_TIME, R.bool.def_auto_time)); // Sync time to NITZ</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.AUTO_TIME_ZONE,</div><div>                    mUtils.getBooleanValue(Settings.Global.AUTO_TIME_ZONE, R.bool.def_auto_time_zone)); // Sync timezone to NITZ</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.STAY_ON_WHILE_PLUGGED_IN,</div><div>                    (&quot;1&quot;.equals(SystemProperties.get(&quot;ro.kernel.qemu&quot;)) ||</div><div>                        mContext.getResources().getBoolean(R.bool.def_stay_on_while_plugged_in))</div><div>                     ? 0 : 0);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Global.WIFI_SLEEP_POLICY,</div><div>                    R.integer.def_wifi_sleep_policy);</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.MODE_RINGER,</div><div>                    AudioManager.RINGER_MODE_NORMAL);</div><div><br/></div><div>            // --- Previously in 'secure'</div><div>            loadBooleanSetting(stmt, Settings.Global.PACKAGE_VERIFIER_ENABLE,</div><div>                    R.bool.def_package_verifier_enable);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.WIFI_ON,</div><div>                    R.bool.def_wifi_on);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON,</div><div>                    R.bool.def_networks_available_notification_on);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.BLUETOOTH_ON,</div><div>                    R.bool.def_bluetooth_on);</div><div><br/></div><div>            // Enable or disable Cell Broadcast SMS</div><div>            loadSetting(stmt, Settings.Global.CDMA_CELL_BROADCAST_SMS,</div><div>                    RILConstants.CDMA_CELL_BROADCAST_SMS_DISABLED);</div><div><br/></div><div>            // Data roaming default, based on build</div><div>            loadSetting(stmt, Settings.Global.DATA_ROAMING,</div><div>                    &quot;true&quot;.equalsIgnoreCase(</div><div>                            SystemProperties.get(&quot;ro.com.android.dataroaming&quot;,</div><div>                                    &quot;false&quot;)) ? 1 : 0);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.DEVICE_PROVISIONED,</div><div>                    R.bool.def_device_provisioned);</div><div><br/></div><div>            final int maxBytes = mContext.getResources().getInteger(</div><div>                    R.integer.def_download_manager_max_bytes_over_mobile);</div><div>            if (maxBytes &gt; 0) {</div><div>                loadSetting(stmt, Settings.Global.DOWNLOAD_MAX_BYTES_OVER_MOBILE,</div><div>                        Integer.toString(maxBytes));</div><div>            }</div><div><br/></div><div>            final int recommendedMaxBytes = mContext.getResources().getInteger(</div><div>                    R.integer.def_download_manager_recommended_max_bytes_over_mobile);</div><div>            if (recommendedMaxBytes &gt; 0) {</div><div>                loadSetting(stmt, Settings.Global.DOWNLOAD_RECOMMENDED_MAX_BYTES_OVER_MOBILE,</div><div>                        Integer.toString(recommendedMaxBytes));</div><div>            }</div><div><br/></div><div>            ///M: Mobile Data default, based on build</div><div>            loadSetting(stmt, Settings.Global.MOBILE_DATA,</div><div>                    mUtils.getValue(Settings.Global.MOBILE_DATA, Settings.Secure.MOBILE_DATA_DEFAULT));</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.NETSTATS_ENABLED,</div><div>                    R.bool.def_netstats_enabled);</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.INSTALL_NON_MARKET_APPS,</div><div>                    mUtils.getBooleanValue(Settings.Global.INSTALL_NON_MARKET_APPS, R.bool.def_install_non_market_apps));</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.USB_MASS_STORAGE_ENABLED,</div><div>                    R.bool.def_usb_mass_storage_enabled);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Global.WIFI_MAX_DHCP_RETRY_COUNT,</div><div>                    R.integer.def_max_dhcp_retries);</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.WIFI_DISPLAY_ON,</div><div>                    R.bool.def_wifi_display_on);</div><div><br/></div><div>            loadStringSetting(stmt, Settings.Global.LOCK_SOUND,</div><div>                    R.string.def_lock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.UNLOCK_SOUND,</div><div>                    R.string.def_unlock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.TRUSTED_SOUND,</div><div>                    R.string.def_trusted_sound);</div><div>            loadIntegerSetting(stmt, Settings.Global.POWER_SOUNDS_ENABLED,</div><div>                    R.integer.def_power_sounds_enabled);</div><div>            loadStringSetting(stmt, Settings.Global.LOW_BATTERY_SOUND,</div><div>                    R.string.def_low_battery_sound);</div><div>            loadIntegerSetting(stmt, Settings.Global.DOCK_SOUNDS_ENABLED,</div><div>                    R.integer.def_dock_sounds_enabled);</div><div>            loadStringSetting(stmt, Settings.Global.DESK_DOCK_SOUND,</div><div>                    R.string.def_desk_dock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.DESK_UNDOCK_SOUND,</div><div>                    R.string.def_desk_undock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.CAR_DOCK_SOUND,</div><div>                    R.string.def_car_dock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.CAR_UNDOCK_SOUND,</div><div>                    R.string.def_car_undock_sound);</div><div>            loadStringSetting(stmt, Settings.Global.WIRELESS_CHARGING_STARTED_SOUND,</div><div>                    R.string.def_wireless_charging_started_sound);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Global.DOCK_AUDIO_MEDIA_ENABLED,</div><div>                    R.integer.def_dock_audio_media_enabled);</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.SET_INSTALL_LOCATION, 0);</div><div>            loadSetting(stmt, Settings.Global.DEFAULT_INSTALL_LOCATION,</div><div>                    PackageHelper.APP_INSTALL_AUTO);</div><div><br/></div><div>            // Set default cdma emergency tone</div><div>            loadSetting(stmt, Settings.Global.EMERGENCY_TONE, 0);</div><div><br/></div><div>            // Set default cdma call auto retry</div><div>            loadSetting(stmt, Settings.Global.CALL_AUTO_RETRY, 0);</div><div><br/></div><div>            // Set default simplified carrier network settings to 0</div><div>            loadSetting(stmt, Settings.Global.HIDE_CARRIER_NETWORK_SETTINGS, 0);</div><div><br/></div><div>            // Set the preferred network mode to target desired value or Default</div><div>            // value defined in RILConstants</div><div>            int type;</div><div>            type = RILConstants.PREFERRED_NETWORK_MODE;</div><div>            loadSetting(stmt, Settings.Global.PREFERRED_NETWORK_MODE, type);</div><div><br/></div><div>            // Set the preferred cdma subscription source to target desired value or default</div><div>            // value defined in CdmaSubscriptionSourceManager</div><div>            type = SystemProperties.getInt(&quot;ro.telephony.default_cdma_sub&quot;,</div><div>                        CdmaSubscriptionSourceManager.PREFERRED_CDMA_SUBSCRIPTION);</div><div>            loadSetting(stmt, Settings.Global.CDMA_SUBSCRIPTION_MODE, type);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Global.LOW_BATTERY_SOUND_TIMEOUT,</div><div>                    R.integer.def_low_battery_sound_timeout);</div><div><br/></div><div>            loadIntegerSetting(stmt, Settings.Global.WIFI_SCAN_ALWAYS_AVAILABLE,</div><div>                    R.integer.def_wifi_scan_always_available);</div><div><br/></div><div>            loadIntegerSetting(stmt, Global.HEADS_UP_NOTIFICATIONS_ENABLED,</div><div>                    R.integer.def_heads_up_enabled);</div><div><br/></div><div>            loadSetting(stmt, Settings.Global.DEVICE_NAME, getDefaultDeviceName());</div><div><br/></div><div>            loadBooleanSetting(stmt, Settings.Global.GUEST_USER_ENABLED,</div><div>                    R.bool.def_guest_user_enabled);</div><div>            loadSetting(stmt, Settings.Global.ENHANCED_4G_MODE_ENABLED, ImsConfig.FeatureValueConstants.ON);</div><div><br/></div><div>            ///M: load MTK new add Global providers.</div><div>            mUtils.loadCustomGlobalSettings(stmt);</div><div>        } finally {</div><div>            if (stmt != null) stmt.close();</div><div>        }</div><div>    }</div><div><br/></div><div>    private void loadSetting(SQLiteStatement stmt, String key, Object value) {</div><div>        stmt.bindString(1, key);</div><div>        stmt.bindString(2, value.toString());</div><div>        stmt.execute();</div><div>    }</div><div><br/></div><div>    private void loadStringSetting(SQLiteStatement stmt, String key, int resid) {</div><div>        loadSetting(stmt, key, mContext.getResources().getString(resid));</div><div>    }</div><div><br/></div><div>    private void loadBooleanSetting(SQLiteStatement stmt, String key, int resid) {</div><div>        loadSetting(stmt, key,</div><div>                mContext.getResources().getBoolean(resid) ? &quot;1&quot; : &quot;0&quot;);</div><div>    }</div><div><br/></div><div>    private void loadIntegerSetting(SQLiteStatement stmt, String key, int resid) {</div><div>        loadSetting(stmt, key,</div><div>                Integer.toString(mContext.getResources().getInteger(resid)));</div><div>    }</div><div><br/></div><div>    private void loadFractionSetting(SQLiteStatement stmt, String key, int resid, int base) {</div><div>        loadSetting(stmt, key,</div><div>                Float.toString(mContext.getResources().getFraction(resid, base, base)));</div><div>    }</div><div><br/></div><div>    private int getIntValueFromSystem(SQLiteDatabase db, String name, int defaultValue) {</div><div>        return getIntValueFromTable(db, TABLE_SYSTEM, name, defaultValue);</div><div>    }</div><div><br/></div><div>    private int getIntValueFromTable(SQLiteDatabase db, String table, String name,</div><div>            int defaultValue) {</div><div>        String value = getStringValueFromTable(db, table, name, null);</div><div>        return (value != null) ? Integer.parseInt(value) : defaultValue;</div><div>    }</div><div><br/></div><div>    private String getStringValueFromTable(SQLiteDatabase db, String table, String name,</div><div>            String defaultValue) {</div><div>        Cursor c = null;</div><div>        try {</div><div>            c = db.query(table, new String[] { Settings.System.VALUE }, &quot;name='&quot; + name + &quot;'&quot;,</div><div>                    null, null, null, null);</div><div>            if (c != null &amp;&amp; c.moveToFirst()) {</div><div>                String val = c.getString(0);</div><div>                return val == null ? defaultValue : val;</div><div>            }</div><div>        } finally {</div><div>            if (c != null) c.close();</div><div>        }</div><div>        return defaultValue;</div><div>    }</div><div><br/></div><div>    private String getOldDefaultDeviceName() {</div><div>        return mContext.getResources().getString(R.string.def_device_name,</div><div>                Build.MANUFACTURER, Build.MODEL);</div><div>    }</div><div><br/></div><div>    private String getDefaultDeviceName() {</div><div>        return mContext.getResources().getString(R.string.def_device_name_simple, Build.MODEL);</div><div>    }</div><div>}</div><div><br/></div></span>
</div></body></html> 