<html>
<head>
  <title>48.Android Camera实现全屏预览</title>
  <basefont face="Microsoft YaHei" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/301769 (zh-CN); Windows/6.3.9600 (Win64);"/>
  <style>
    body, td {
      font-family: Microsoft YaHei;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="696"/>
<h1>48.Android Camera实现全屏预览</h1>

<div>
<span><div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">一、相机参数</span></span></div><ol><li><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">取景范围：CCD和CMOS决定</span></span></li><li><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">取景比例：大多数为3:2和4:3，目前普通手机为4：3</span></span></li></ol><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">二、SDK——Camera类</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">一）、自定义相机的实现</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">     1.使用surfaceview 或继承自 surfaceview的组件作为相机预览的界面；</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">     2. surfaceview实现<span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">SurfaceHolder.Callback接口的</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceCreated、</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceChanged、</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceDestroyed三个方法，在</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceCreated方法中打开摄像头，在</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceChanged中设置camrea的各项         参数，调用camera.</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">startPreview()开启预览；在</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">surfaceDestroyed中</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">停止预览，释放相机。</span></span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;"><span style="background-color: rgb(232, 242, 254);">     3.调用</span>surfaceview.get<span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">SurfaceHolder().</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">addCallback(</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">callback</span><span style="background-color: rgb(232, 242, 254); background-position: initial initial; background-repeat: initial initial;">)实现接口的回调;</span></span></span></div><ol start="4"><li><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;"><span style="color: rgb(63, 63, 63); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; display: inline !important; float: none; background-color: rgb(255, 255, 255);">调用Camera对象的takePicture方法，其第三个参数为PictureCallback接口对象，其中的onPictureTaken回调方法参数中有一个byte数组，存储了拍摄到的图片数据，在方法中保存到本地即可。</span></span></span></li></ol><div align="left"><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;"><span style="background-color: rgb(232, 242, 254);"> 三）、常见问题及其分析</span></span></span></div><div><br/></div><div align="left"><div style="color: rgb(51, 51, 51); font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 14px;"><div><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">     三个尺寸：</span></div></div></div><div><span style="color: rgb(51, 51, 51);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">1、Surfaceview的尺寸</span></span></div><div align="left"><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">Surfaceview是用来预览Camera的，当它全屏时就是Screen的大小。</span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">2、Picturesize的尺寸</span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">这是拍照后的PictureSize尺寸。</span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">3、Previewsize的尺寸</span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">这是预览时帧数据的尺寸。</span></p></div><div><br/></div><div align="left"><div style="color: rgb(51, 51, 51); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="color: rgb(51, 51, 51);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">     三种变形：</span></span></div></div></div><div align="left"><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;">1、预览画面的物体长宽失真。原因是<span style="font-size: 18px;">Surfaceview和<span style="font-size: 18px;">Previewsize的长宽比率不一致，就会导致预览画面上失真。因为camera在显示时会将预览帧数据缩放成<span style="font-size: 18px;">Surfaceview大小，当比率不一致必然会物体变形。至于这个缩放算法可能不同手机会有区别。</span></span></span></span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;">2、拍照后照片上物体变形。</span></span></span></span></p><p style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;">3、点击拍照瞬间，预览画面上会突然变形然后恢复到正常预览。 </span></span></span></span></p></div><div><span style="color: rgb(51, 51, 51);"><span style="font-family: &apos;Comic Sans MS&apos;; font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;"><span style="font-size: 18px;">2、3两种变形都是因为<span style="font-size: 18px;">Previewsize和<span style="font-size: 18px;">Picturesize的长宽比率不一致所致。总之一句话，为了保证图片不是真，要保证预览Surfaceview、Previewsize、Picturesize的长宽比率要一直。如果Surfaceview是全屏的话，要获取屏幕长和宽得到比率。</span></span></span></span></span></span></span></div><div><span style="font-size: 18px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;">四）、全屏预览的缺点</span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;">     1.普通拍照 </span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><img src="48.Android Camera实现全屏预览_files/Image.png" type="image/png" style="height:auto;" width="372"/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;">     手机屏幕比例16:9，照片比例4:3</span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;">      2.全屏预览</span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><img src="48.Android Camera实现全屏预览_files/Image [1].png" type="image/png" style="height:auto;" width="374"/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;">     3.对比结果</span></span></div><div><span style="font-size: 19px;"><span style="font-family: &apos;Comic Sans MS&apos;;"><img src="48.Android Camera实现全屏预览_files/360截图20160323120532011.png" type="image/png" style="height: auto;"/></span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">在 【相机取到的4:3的图像中】 取了 【其中的16:9范围】</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">二）实现方式</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">第一种：初始化相机参数的时候，设置预览尺寸比例、照片尺寸比例和屏幕尺寸比例一样</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><img src="48.Android Camera实现全屏预览_files/360截图20160323143444303.png" type="image/png" style="height:auto;" width="391"/></span><img src="48.Android Camera实现全屏预览_files/360截图20160323143521240.png" type="image/png" style="height: auto;"/></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><br/></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 19px;">第二种：</span></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;">1.<font color="#010101" size="4"><span style="font-size:14pt">修改</span></font> <font color="#010101" size="4"><span style="font-size:14pt">Camera.xml</span></font><font color="#010101" size="4"><span style="font-size:14pt">。把</span></font><font color="#010101" size="4"><span style="font-size:14pt">SurfaceView</span></font> <font color="#010101" size="4"><span style="font-size:14pt">放在一个</span></font> <font color="#010101" size="4"><span style="font-size:14pt">AbsoluteLayout</span></font><font color="#010101" size="4"><span style="font-size:14pt">绝对布局里面，给绝对布局</span></font> <font color="#010101" size="4"><span style="font-size:14pt">AbsoluteLayout</span></font><font color="#010101" size="4"><span style="font-size:14pt">设置</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_width</span></font> <font color="#010101" size="4"><span style="font-size:14pt">属性和</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_height</span></font><font color="#010101" size="4"><span style="font-size:14pt">属性分别为</span></font> <font color="#010101" size="4"><span style="font-size:14pt">480px</span></font><font color="#010101" size="4"><span style="font-size:14pt">和</span></font><font color="#010101" size="4"><span style="font-size:14pt">360px</span></font> <font color="#010101" size="4"><span style="font-size:14pt">（这里手机屏幕是</span></font> <font color="#010101" size="4"><span style="font-size:14pt">480x320</span></font><font color="#010101" size="4"><span style="font-size:14pt">，如果手机屏幕是</span></font><font color="#010101" size="4"><span style="font-size:14pt">800x480</span></font><font color="#010101" size="4"><span style="font-size:14pt">，就设置成</span></font> <font color="#010101" size="4"><span style="font-size:14pt">800px</span></font><font color="#010101" size="4"><span style="font-size:14pt">和</span></font><font color="#010101" size="4"><span style="font-size:14pt">600px</span></font> <font color="#010101" size="4"><span style="font-size:14pt">），我们必须保持</span></font> <font color="#010101" size="4"><span style="font-size:14pt">AbsoluteLayout</span></font><font color="#010101" size="4"><span style="font-size:14pt">的这个长宽属性比例为</span></font><font color="#010101" size="4"><span style="font-size:14pt">4:3</span></font><font color="#010101" size="4"><span style="font-size:14pt">，并且要保证设置的长宽均大于等于手机屏幕尺寸的大小。</span></font></span></div><div align="justify"><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 14pt;"><span style="color: rgb(1, 1, 1);">2.</span></span><font color="#010101" size="4"><span style="font-size:14pt">把</span></font><font color="#010101" size="4"><span style="font-size:14pt">SurfaceView</span></font><font color="#010101" size="4"><span style="font-size:14pt">的</span></font> <font color="#010101" size="4"><span style="font-size:14pt">android:layout_x</span></font><font color="#010101" size="4"><span style="font-size:14pt">属性设置为</span></font><font color="#010101" size="4"><span style="font-size:14pt">0px</span></font><font color="#010101" size="4"><span style="font-size:14pt">；把</span></font> <font color="#010101" size="4"><span style="font-size:14pt">SurfaceView</span></font><font color="#010101" size="4"><span style="font-size:14pt">的</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_y</span></font> <font color="#010101" size="4"><span style="font-size:14pt">属性设置为</span></font> <span style="font-size:14pt"><span style="color: rgb(1, 1, 1);">-</span><font color="#010101" size="4">（</font></span><font color="#010101" size="4"><span style="font-size:14pt">AbsoluteLayout</span></font> <font color="#010101" size="4"><span style="font-size:14pt">的</span></font><font color="#010101" size="4"><span style="font-size:14pt">height</span></font><font color="#010101" size="4"><span style="font-size:14pt">属性</span></font> <font color="#010101" size="4"><span style="font-size:14pt">-</span></font><font color="#010101" size="4"><span style="font-size:14pt">手机屏幕的宽）</span></font><font color="#010101" size="4"><span style="font-size:14pt">/ 2;</span></font><font color="#010101" size="4"><span style="font-size:14pt">除此之外，还要把</span></font> <font color="#010101" size="4"><span style="font-size:14pt">SurfaceView</span></font><font color="#010101" size="4"><span style="font-size:14pt">的</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_width</span></font> <font color="#010101" size="4"><span style="font-size:14pt">属性和</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_height</span></font><font color="#010101" size="4"><span style="font-size:14pt">属性设置成和</span></font> <font color="#010101" size="4"><span style="font-size:14pt">AbsoluteLayout</span></font><font color="#010101" size="4"><span style="font-size:14pt">的一样。</span></font></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><span style="font-size: 14pt;"><span style="color: rgb(1, 1, 1);">3.</span></span><font color="#010101" size="4"><span style="font-size:14pt">pictureSize</span></font><font color="#010101" size="4"> 和</font><font color="#010101" size="4"><span style="font-size:14pt">previewSize</span></font> <font color="#010101" size="4"><span style="font-size:14pt">的长宽比例要保证为</span></font><font color="#010101" size="4"><span style="font-size:14pt">4:3；</span></font></span></div><div><span style="font-family: &apos;Comic Sans MS&apos;;"><font color="#010101" size="4"><span style="font-size: 19px;"><b>     使用中存在问题的解决办法</b></span></font></span></div><div style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:2.11mm; margin-bottom:2.11mm;"><div><span style="font-family: &apos;Comic Sans MS&apos;;"><font color="#010101" size="4"><span style="font-size:14pt">切换摄像头动画就会出现一个问题：那就是切换摄像头的时候取的最后一帧数据会上下同时往中甲挤压一下做动画。这个问题的原因也很简单，因为我们预览的</span></font> <font color="#010101" size="4"><span style="font-size:14pt">pictureSize</span></font><font color="#010101" size="4"><span style="font-size:14pt">做成了</span></font><font color="#010101" size="4"><span style="font-size:14pt">480x360</span></font> <font color="#010101" size="4"><span style="font-size:14pt">，而我们的切换摄像头的动画是一个</span></font> <font color="#010101" size="4"><span style="font-size:14pt">ImageView</span></font><font color="#010101" size="4"><span style="font-size:14pt">，定义在</span></font><font color="#010101" size="4"><span style="font-size:14pt">Camera.xml</span></font> <font color="#010101" size="4"><span style="font-size:14pt">里面，而给它设置的长宽为</span></font> <font color="#010101" size="4"><span style="font-size:14pt">480px</span></font><font color="#010101" size="4"><span style="font-size:14pt">和</span></font><font color="#010101" size="4"><span style="font-size:14pt">320px</span></font> <font color="#010101" size="4"><span style="font-size:14pt">，相差</span></font><font color="#010101" size="4"><span style="font-size:14pt">40px</span></font><font color="#010101" size="4"><span style="font-size:14pt">，这样在做动画的时候要把</span></font> <font color="#010101" size="4"><span style="font-size:14pt">360</span></font><font color="#010101" size="4"><span style="font-size:14pt">转换为</span></font><font color="#010101" size="4"><span style="font-size:14pt">320</span></font> <font color="#010101" size="4"><span style="font-size:14pt">之后才去做动画，所以才会往中间挤压一下从</span></font> <font color="#010101" size="4"><span style="font-size:14pt">360px</span></font><font color="#010101" size="4"><span style="font-size:14pt">变成</span></font><font color="#010101" size="4"><span style="font-size:14pt">320px</span></font> <font color="#010101" size="4"><span style="font-size:14pt">。问题的解法也很简单，给</span></font> <font color="#010101" size="4"><span style="font-size:14pt">ImageView</span></font><font color="#010101" size="4"><span style="font-size:14pt">添加</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_marginTop</span></font> <font color="#010101" size="4"><span style="font-size:14pt">属性和</span></font><font color="#010101" size="4"><span style="font-size:14pt">android:layout_marginBottom</span></font><font color="#010101" size="4"><span style="font-size:14pt">属性，都设置为</span></font> <font color="#010101" size="4"><span style="font-size:14pt">-21px</span></font><font color="#010101" size="4"><span style="font-size:14pt">，可能会有一个疑问，为什么不去设置成</span></font> <font color="#010101" size="4"><span style="font-size:14pt">-20px</span></font><font color="#010101" size="4"><span style="font-size:14pt">，却要设置成</span></font><font color="#010101" size="4"><span style="font-size:14pt">-21px</span></font><font color="#010101" size="4"><span style="font-size:14pt">？由于这个</span></font> <font color="#010101" size="4"><span style="font-size:14pt">ImageView</span></font><font color="#010101" size="4"><span style="font-size:14pt">的边框占有</span></font><font color="#010101" size="4"><span style="font-size:14pt">1px</span></font><font color="#010101" size="4"><span style="font-size:14pt">，所以我们才去设置成</span></font> <font color="#010101" size="4"><span style="font-size:14pt">-21px</span></font><font color="#010101" size="4"><span style="font-size:14pt">，而不是</span></font><font color="#010101" size="4"><span style="font-size:14pt">-20px</span></font> <font color="#010101" size="4"><span style="font-size:14pt">。</span></font></span></div></div></div></span>
</div></body></html> 